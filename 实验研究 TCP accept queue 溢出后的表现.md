# 实验研究 TCP accept queue 溢出后的表现

## 背景信息

我们都知道 `listen()` 函数有个参数叫 `backlog` ，其值对 accept queue 的长度有影响，当成功完成三次握手的 TCP connection 进入 accept queue 后，如果不能及时调用 `accept()` 把连接从 accept queue 中取走，根据 UNP 的说法，accept queue 满后，TCP 协议栈将不会对再对建立新连接的 SYN 包进行应答，因此，发起连接建立的一侧在调用 connect() 后，会返回 ETIMEDOUT 。但**实际上 Linux 的行为不是这样的！！！**

注意：是否设置 `/proc/sys/net/ipv4/tcp_abort_on_overflow` 对 listen queue 满后的行为是有影响的；如果设置为 1 ，那么 connect 就会被 RST 掉；

## 实验验证

### 0x01 验证 accept queue 满后，新建连接时的表现

- Server 侧监听

```
[#1#root@ubuntu-1604 ~]$nc -l 12345
（卡住）
```

- 查看进程状态

```
[#1#root@ubuntu-1604 ~]$ps aux | grep "12345"
root     21769  0.0  0.0   9180   892 pts/3    S+   10:42   0:00 nc -l 12345
...
[#2#root@ubuntu-1604 ~]$
```

- 发送 SIGSTOP 信号给 server ，确认进程状态变化（进程状态变为 T 后，将无法再 accept 新的 inbound connections）

```
[#2#root@ubuntu-1604 ~]$kill -SIGSTOP 21769
[#3#root@ubuntu-1604 ~]$
[#3#root@ubuntu-1604 ~]$ps aux | grep "12345"
root     21769  0.0  0.0   9180   892 pts/3    T    10:42   0:00 nc -l 12345
...
[#4#root@ubuntu-1604 ~]$
```

之前的监听命令输出

```
[#1#root@ubuntu-1604 ~]$nc -l 12345
（卡住）
[1]+  Stopped                 nc -l 12345
[#2#root@ubuntu-1604 ~]$
```

> 问题：SIGSTOP/SIGCONT 的作用？见《[Two great signals: SIGSTOP and SIGCONT](https://major.io/2009/06/15/two-great-signals-sigstop-and-sigcont/)》

- 查看 12345 监听端口情况

```
[#5#root@ubuntu-1604 ~]$ss -natp | grep "12345"
LISTEN     0      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
[#6#root@ubuntu-1604 ~]$
```

- 发起客户端连接（第一次）

```
[#7#root@ubuntu-1604 ~]$nc localhost 12345
（卡住）
```

之后查看连接状态

```
[#3#root@ubuntu-1604 ~]$ss -natp | grep "12345"
LISTEN     1      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:12345              127.0.0.1:45688
[#4#root@ubuntu-1604 ~]$
```

> NOTE：进程被 SIGSTOP 后处于 T 状态，仍旧能够完成 TCP 连接的建立，但无法 accept 该连接，故积压在 Recv-Q 中；

- 发起客户端连接（第二次）

```
[#1#root@ubuntu-1604 ~]$nc localhost 12345
（卡住）
```

之后查看连接状态

```
[#6#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#7#root@ubuntu-1604 ~]$
```

> NOTE：进程收到 SIGSTOP 信号后会进入 T 状态，但底层协议栈仍旧能够完成 TCP 连接的建立（max + 1），但无法 accept 该连接，故积压在 Recv-Q 中；

> 问题：可以看到，一段时间后，上述 ESTAB 连接的 Recv-Q 中会出现数值，表示有数据位于接受缓冲区中；这是什么数据？如何增长？（被我回车导致的应该是）

- 发起客户端连接（第三次）

```
[#1#root@ubuntu-1604 ~]$nc localhost 12345
（卡住）
```

之后查看连接状态

```
[#26#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:45740               timer:(on,3.208ms,2)
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#27#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:45740               timer:(on,6.068ms,3)
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#28#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:45740               timer:(on,3.532ms,3)
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#29#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:45740               timer:(on,1.352ms,3)
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#30#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:45740               timer:(on,15sec,4)
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#31#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:45740               timer:(on,13sec,4)
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#32#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:45740               timer:(on,9.892ms,4)
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#33#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:45740               timer:(on,7.276ms,4)
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#34#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:45740               timer:(on,5.688ms,4)
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#35#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:45740               timer:(on,4sec,4)
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#36#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:45740               timer:(on,2.696ms,4)
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#37#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:45740               timer:(on,952ms,4)
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#38#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:45740               timer:(on,31sec,5)
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#39#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:45740               timer:(on,29sec,5)
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#40#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:45740               timer:(on,28sec,5)
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#41#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:45740               timer:(on,27sec,5)
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#42#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:45740               timer:(on,26sec,5)
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#43#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:45740               timer:(on,25sec,5)
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#44#root@ubuntu-1604 ~]$
[#44#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:45740               timer:(on,1.356ms,5)
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#45#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:45740               timer:(on,032ms,5)
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#46#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#47#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#48#root@ubuntu-1604 ~]$
[#48#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#49#root@ubuntu-1604 ~]$
[#49#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#50#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#51#root@ubuntu-1604 ~]$ss -natp -o | grep "12345"
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=21769,fd=3))
ESTAB      0      0      127.0.0.1:45688              127.0.0.1:12345               users:(("nc",pid=26056,fd=3))
ESTAB      0      0      127.0.0.1:45710              127.0.0.1:12345               users:(("nc",pid=28427,fd=3))
ESTAB      1      0      127.0.0.1:12345              127.0.0.1:45710
ESTAB      0      0      127.0.0.1:45740              127.0.0.1:12345               users:(("nc",pid=31792,fd=3))
ESTAB      2      0      127.0.0.1:12345              127.0.0.1:45688
[#52#root@ubuntu-1604 ~]$
```

实验结论：

- 进程被 SIGSTOP 后处于 T 状态，能够成功建立的 TCP 连接的数量为 Send-Q + 1 ，当第三个完成三次握手的连接是无法进入 accept queue 的，因此此时看到积压在 Recv-Q 中的数值仍旧是 2 ；
- 在这种情况下，完成三次握手的连接是保存在 syn queue 中的，此时协议栈会回复 SYN+ACK 给 client ，而 client 收到后再回复 ACK ；之后 client 认为连接建立成功，而 server 侧认为连接建立未成功，故此时针对第三个连接会同时看到 SYN-RECV 和 ESTAB 状态，即 half-open 情况；
- 由于 SYN-RECV 是有重传次数限制的，故一定时间后，该状态会消失；



### 0x02 验证进程被 SIGSTOP 后，client 新建连接后再断开的表现


- Server 侧监听

```
[#1#root@ubuntu-1604 ~]$nc -l 12345
（卡住）
```

- 状态观测

```
[#175#root@ubuntu-1604 ~]$while [ 1 ]; do ss -natp -o | grep "12345"; sleep 1; echo "---"; done
LISTEN     0      1            *:12345                    *:*                   users:(("nc",pid=16430,fd=3))
---
LISTEN     0      1            *:12345                    *:*                   users:(("nc",pid=16430,fd=3))
---
...
LISTEN     1      1            *:12345                    *:*                   users:(("nc",pid=16430,fd=3))  -- 建立第一个连接后
ESTAB      0      0      127.0.0.1:12345              127.0.0.1:46434
ESTAB      0      0      127.0.0.1:46434              127.0.0.1:12345               users:(("nc",pid=16959,fd=3))
---
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=16430,fd=3))  -- 建立第二个连接后
ESTAB      0      0      127.0.0.1:12345              127.0.0.1:46436
ESTAB      0      0      127.0.0.1:12345              127.0.0.1:46434
ESTAB      0      0      127.0.0.1:46436              127.0.0.1:12345               users:(("nc",pid=16973,fd=3))
ESTAB      0      0      127.0.0.1:46434              127.0.0.1:12345               users:(("nc",pid=16959,fd=3))
...
---
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=16430,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:46438               timer:(on,116ms,0)  -- 发起第三个连接
ESTAB      0      0      127.0.0.1:46438              127.0.0.1:12345               users:(("nc",pid=17010,fd=3))
ESTAB      0      0      127.0.0.1:12345              127.0.0.1:46436
ESTAB      0      0      127.0.0.1:12345              127.0.0.1:46434
ESTAB      0      0      127.0.0.1:46436              127.0.0.1:12345               users:(("nc",pid=16973,fd=3))
ESTAB      0      0      127.0.0.1:46434              127.0.0.1:12345               users:(("nc",pid=16959,fd=3))
...
---
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=16430,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:46438               timer:(on,4.708ms,4)
FIN-WAIT-1 0      1      127.0.0.1:46438              127.0.0.1:12345               timer:(on,600ms,2)  -- 断开第三条连接
ESTAB      0      0      127.0.0.1:12345              127.0.0.1:46436
ESTAB      0      0      127.0.0.1:12345              127.0.0.1:46434
ESTAB      0      0      127.0.0.1:46436              127.0.0.1:12345               users:(("nc",pid=16973,fd=3))
ESTAB      0      0      127.0.0.1:46434              127.0.0.1:12345               users:(("nc",pid=16959,fd=3))
---
...
---
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=16430,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:46438               timer:(on,30sec,5)
FIN-WAIT-1 0      1      127.0.0.1:46438              127.0.0.1:12345               timer:(on,5.716ms,5)
CLOSE-WAIT 1      0      127.0.0.1:12345              127.0.0.1:46436   -- 断开第二条连接
ESTAB      0      0      127.0.0.1:12345              127.0.0.1:46434
FIN-WAIT-2 0      0      127.0.0.1:46436              127.0.0.1:12345               timer:(timewait,59sec,0)
ESTAB      0      0      127.0.0.1:46434              127.0.0.1:12345               users:(("nc",pid=16959,fd=3))
---
...
---
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=16430,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:46438               timer:(on,156ms,5)  -- 重传结束前最后一次出现
FIN-WAIT-1 0      1      127.0.0.1:46438              127.0.0.1:12345               timer:(on,13sec,7)
CLOSE-WAIT 1      0      127.0.0.1:12345              127.0.0.1:46436
ESTAB      0      0      127.0.0.1:12345              127.0.0.1:46434
FIN-WAIT-2 0      0      127.0.0.1:46436              127.0.0.1:12345               timer:(timewait,28sec,0)
ESTAB      0      0      127.0.0.1:46434              127.0.0.1:12345               users:(("nc",pid=16959,fd=3))
---
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=16430,fd=3))
FIN-WAIT-1 0      1      127.0.0.1:46438              127.0.0.1:12345               timer:(on,12sec,7)
CLOSE-WAIT 1      0      127.0.0.1:12345              127.0.0.1:46436
ESTAB      0      0      127.0.0.1:12345              127.0.0.1:46434
FIN-WAIT-2 0      0      127.0.0.1:46436              127.0.0.1:12345               timer:(timewait,27sec,0)
ESTAB      0      0      127.0.0.1:46434              127.0.0.1:12345               users:(("nc",pid=16959,fd=3))
---
...
---
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=16430,fd=3))
FIN-WAIT-1 0      1      127.0.0.1:46438              127.0.0.1:12345               timer:(on,512ms,7)  -- 重传结束前最后一次出现
CLOSE-WAIT 1      0      127.0.0.1:12345              127.0.0.1:46436
ESTAB      0      0      127.0.0.1:12345              127.0.0.1:46434
FIN-WAIT-2 0      0      127.0.0.1:46436              127.0.0.1:12345               timer:(timewait,15sec,0)
ESTAB      0      0      127.0.0.1:46434              127.0.0.1:12345               users:(("nc",pid=16959,fd=3))
---
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=16430,fd=3))
CLOSE-WAIT 1      0      127.0.0.1:12345              127.0.0.1:46436
ESTAB      0      0      127.0.0.1:12345              127.0.0.1:46434
FIN-WAIT-2 0      0      127.0.0.1:46436              127.0.0.1:12345               timer:(timewait,14sec,0)
ESTAB      0      0      127.0.0.1:46434              127.0.0.1:12345               users:(("nc",pid=16959,fd=3))
---
...
---
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=16430,fd=3))
CLOSE-WAIT 1      0      127.0.0.1:12345              127.0.0.1:46436
ESTAB      0      0      127.0.0.1:12345              127.0.0.1:46434
FIN-WAIT-2 0      0      127.0.0.1:46436              127.0.0.1:12345               timer:(timewait,360ms,0) -- 重传结束前最后一次出现
ESTAB      0      0      127.0.0.1:46434              127.0.0.1:12345               users:(("nc",pid=16959,fd=3))
---
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=16430,fd=3))  -- 稳定状态：1 CLOSE-WAIT + 1 ESTAB
CLOSE-WAIT 1      0      127.0.0.1:12345              127.0.0.1:46436
ESTAB      0      0      127.0.0.1:12345              127.0.0.1:46434
ESTAB      0      0      127.0.0.1:46434              127.0.0.1:12345               users:(("nc",pid=16959,fd=3))
---
...
---
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=16430,fd=3))
CLOSE-WAIT 1      0      127.0.0.1:12345              127.0.0.1:46436
CLOSE-WAIT 1      0      127.0.0.1:12345              127.0.0.1:46434
FIN-WAIT-2 0      0      127.0.0.1:46434              127.0.0.1:12345               timer:(timewait,59sec,0)  -- 断开第一条连接
---
...
---
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=16430,fd=3))
CLOSE-WAIT 1      0      127.0.0.1:12345              127.0.0.1:46436
CLOSE-WAIT 1      0      127.0.0.1:12345              127.0.0.1:46434
ESTAB      0      0      127.0.0.1:46448              127.0.0.1:12345               users:(("nc",pid=18305,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:46448               timer:(on,760ms,0)  -- 建立第四条连接
FIN-WAIT-2 0      0      127.0.0.1:46434              127.0.0.1:12345               timer:(timewait,52sec,0)
---
...
---
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=16430,fd=3))
CLOSE-WAIT 1      0      127.0.0.1:12345              127.0.0.1:46436
CLOSE-WAIT 1      0      127.0.0.1:12345              127.0.0.1:46434
ESTAB      0      0      127.0.0.1:46448              127.0.0.1:12345               users:(("nc",pid=18305,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:46448               timer:(on,10sec,5)
FIN-WAIT-2 0      0      127.0.0.1:46434              127.0.0.1:12345               timer:(timewait,744ms,0) -- 重传结束前最后一次出现
---
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=16430,fd=3))
CLOSE-WAIT 1      0      127.0.0.1:12345              127.0.0.1:46436
CLOSE-WAIT 1      0      127.0.0.1:12345              127.0.0.1:46434
ESTAB      0      0      127.0.0.1:46448              127.0.0.1:12345               users:(("nc",pid=18305,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:46448               timer:(on,9.960ms,5)
---
...
---
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=16430,fd=3))
CLOSE-WAIT 1      0      127.0.0.1:12345              127.0.0.1:46436
CLOSE-WAIT 1      0      127.0.0.1:12345              127.0.0.1:46434
ESTAB      0      0      127.0.0.1:46448              127.0.0.1:12345               users:(("nc",pid=18305,fd=3))
SYN-RECV   0      0      127.0.0.1:12345              127.0.0.1:46448               timer:(on,824ms,5) -- 重传结束前最后一次出现
---
LISTEN     2      1            *:12345                    *:*                   users:(("nc",pid=16430,fd=3))
CLOSE-WAIT 1      0      127.0.0.1:12345              127.0.0.1:46436
CLOSE-WAIT 1      0      127.0.0.1:12345              127.0.0.1:46434
ESTAB      0      0      127.0.0.1:46448              127.0.0.1:12345               users:(("nc",pid=18305,fd=3))
---
```

实验结论：

- accept queue 中维护的是完成三次握手后的 TCP 连接，若由于某种原因不进行 accept 调用，则会导致队列积压，更进一步，若此时 client 侧进行了连接关闭，则 server 侧会看到 ESTAB 变为 CLOSE-WAIT ，这也就是为何有时会看到 accept queue 溢出时，其数值大于等于 CLOSE-WAIT 数量的原因；
- 当 accept queue 溢出后，若再有 client 发起连接建立，则 client 侧会认为连接建立成功，server 侧则会将连接信息保存在 syn queue 中，并通过重发 SYN+ACK 缓解该问题；当 server 侧由于某种原因一直处于溢出状态时，经过一段超时时间后（SYN+ACK 重传总时间），server 侧会清除相应的连接信息，而 client 侧仍旧认为连接存在；若后续 client 使用该连接进行数据发送，则会触发 server 侧直接发送 RST ；
- 从 FIN-WAIT-1 的 Send-Q 为 1 可以知道，由于 accept queue 溢出原因，暂时维护在 syn queue 中的连接，并不会对 FIN 包做出回应（根本就不接收）；
- 从 CLOSE-WAIT 的 Recv-Q 为 1 可以知道，FIN 包已经到了 server 侧，但不会被接收；


### 0x03 模拟线上 kube-proxy 发生 accept queue 溢出情况时的系统表现


- server 侧

```
import time
import socket
import struct

HOST = 'localhost'
PORT = 8000

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.bind((HOST, PORT))
s.listen(128)

print("[*] Listening on %s:%d" % (HOST, PORT))

#/usr/include/linux/tcp.h
struct_tcp_info = struct.Struct('7B 24I')

while True:
    buf = s.getsockopt(socket.IPPROTO_TCP, socket.TCP_INFO, 104)
    #buf = s.getsockopt(socket.IPPROTO_TCP, socket.TCP_INFO, 1024)
    tcp_info = struct_tcp_info.unpack(buf)
    tcpi_unacked, tcpi_sacked = tcp_info[11:13]

    print 'tcpi_unacked:', tcpi_unacked, 'tcpi_sacked:', tcpi_sacked

    time.sleep(1)
```

> 说明：
>
> - server 端不调用 accept ；
> - 基于 TCP_INFO 获取相关信息；


- client 侧

```
[#148#root@ubuntu-1604 ~/workspace/SandBox/tcp_acceptqueue_overflow]$for i in $(seq 129) ; do nohup nc localhost 8000; sleep 0.5; echo "---"; done
```

- 运行后的系统表现

```
[#30#root@ubuntu-1604 ~/workspace/SandBox/tcp_acceptqueue_overflow]$python server.py
[*] Listening on localhost:8000
tcpi_unacked: 0 tcpi_sacked: 128
...
tcpi_unacked: 127 tcpi_sacked: 128
tcpi_unacked: 128 tcpi_sacked: 128
tcpi_unacked: 129 tcpi_sacked: 128
tcpi_unacked: 129 tcpi_sacked: 128
...
```

最终状态稳定在

```
[#474#root@ubuntu-1604 ~/workspace/kernel/linux-3.13.11]$ss -natp -o |grep "8000"
LISTEN     129    128    127.0.0.1:8000                     *:*                   users:(("python",pid=4724,fd=3))
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49530
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49564
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49506
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49454
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49424
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49558
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49394
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49388
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49484
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49360
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49518
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49570
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49426
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49416
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49328
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49554
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49450
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49332
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49406
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49556
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49386
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49410
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49336
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49498
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49362
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49520
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49464
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49404
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49516
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49306
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49330
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49364
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49368
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49478
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49442
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49346
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49430
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49390
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49456
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49504
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49458
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49378
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49322
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49324
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49460
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49420
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49398
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49334
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49548
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49568
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49314
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49544
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49468
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49496
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49550
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49482
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49440
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49546
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49444
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49560
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49492
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49470
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49418
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49494
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49402
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49462
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49310
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49486
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49436
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49552
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49528
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49288
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49526
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49350
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49318
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49446
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49380
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49326
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49312
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49466
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49320
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49422
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49474
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49452
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49510
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49372
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49524
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49508
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49522
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49384
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49400
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49348
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49414
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49476
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49566
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49374
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49412
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49428
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49338
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49356
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49396
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49472
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49392
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49340
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49438
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49480
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49316
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49304
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49502
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49512
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49298
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49376
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49358
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49488
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49354
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49370
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49562
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49514
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49432
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49448
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49382
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49490
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49434
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49576
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49352
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49408
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49308
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49366
CLOSE-WAIT 1      0      127.0.0.1:8000               127.0.0.1:49500
[#475#root@ubuntu-1604 ~/workspace/kernel/linux-3.13.11]$
[#476#root@ubuntu-1604 ~/workspace/kernel/linux-3.13.11]$ss -natp -o | grep "8000" | wc -l
130
[#477#root@ubuntu-1604 ~/workspace/kernel/linux-3.13.11]$
```

- 抓包验证

启动抓包

```
[#138#root@ubuntu-1604 ~/workspace/SandBox/tcp_acceptqueue_overflow]$tcpdump -i lo tcp port 8000 -s 0 -w 8000.pcap
tcpdump: listening on lo, link-type EN10MB (Ethernet), capture size 262144 bytes
^C15 packets captured
30 packets received by filter
0 packets dropped by kernel
[#139#root@ubuntu-1604 ~/workspace/SandBox/tcp_acceptqueue_overflow]$
```

发起一个新连接

```
[#149#root@ubuntu-1604 ~/workspace/SandBox/tcp_acceptqueue_overflow]$nc localhost 8000
（等待足够 SYN+ACK 重传完毕的时间）
^C
[#150#root@ubuntu-1604 ~/workspace/SandBox/tcp_acceptqueue_overflow]$
```

抓包分析图

![](https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/8000%20%E7%AB%AF%E5%8F%A3%20accept%20queue%20%E6%BB%A1%E4%B9%8B%E5%90%8E%E6%96%B0%E5%BB%BA%E8%BF%9E%E6%8E%A5%E6%97%B6%E7%9A%84%E6%83%85%E5%86%B5.png)


注意：以上讨论均基于 `tcp_abort_on_overflow` 为 0 这个前提条件，若设置 `tcp_abort_on_overflow` 为 1 ，则溢出后发起新连接的表现为

![](https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/%E8%AE%BE%E7%BD%AE%20tcp_abort_on_overflow%20%E4%B8%BA%201%20%E5%90%8E%20accept%20queue%20%E6%BA%A2%E5%87%BA%E6%97%B6%E7%9A%84%E8%BF%9E%E6%8E%A5%E5%BB%BA%E7%AB%8B%E6%83%85%E5%86%B5.png)


### TCP_INFO

在 include/uapi/linux/tcp.h 中有

```
/* for TCP_INFO socket option */
#define TCPI_OPT_TIMESTAMPS 1
#define TCPI_OPT_SACK       2
#define TCPI_OPT_WSCALE     4
#define TCPI_OPT_ECN        8 /* ECN was negociated at TCP session init */
#define TCPI_OPT_ECN_SEEN   16 /* we received at least one packet with ECT */
#define TCPI_OPT_SYN_DATA   32 /* SYN-ACK acked data in SYN sent or rcvd */

...

struct tcp_info {  
    __u8 tcpi_state; /* TCP 状态 */  
    __u8 tcpi_ca_state; /* TCP 拥塞状态 */  
    __u8 tcpi_retransmits; /* 超时重传的次数 */  
    __u8 tcpi_probes; /* 持续定时器或保活定时器发送且未确认的段数*/  
    __u8 tcpi_backoff; /* 退避指数 */  
    __u8 tcpi_options; /* 时间戳选项、SACK 选项、窗口扩大选项、ECN 选项是否启用 */  
    __u8 tcpi_snd_wscale : 4, tcpi_rcv_wscale : 4; /* 发送、接收的窗口扩大因子 */  
  
    __u32 tcpi_rto; /* 超时时间，单位为微秒 */  
    __u32 tcpi_ato; /* 延时确认的估值，单位为微秒 */  
    __u32 tcpi_snd_mss; /* 本端的 MSS */  
    __u32 tcpi_rcv_mss; /* 对端的 MSS */  
  
    __u32 tcpi_unacked; /* 未确认的数据段数，或者 current listen backlog */  
    __u32 tcpi_sacked; /* SACKed 的数据段数，或者 listen backlog set in listen() */  
    __u32 tcpi_lost; /* 丢失且未恢复的数据段数 */  
    __u32 tcpi_retrans; /* 重传且未确认的数据段数 */  
    __u32 tcpi_fackets; /* FACKed 的数据段数 */  
  
    /* Times. 单位为毫秒 */  
    __u32 tcpi_last_data_sent; /* 最近一次发送数据包在多久之前 */  
    __u32 tcpi_last_ack_sent;  /* Not remembered, sorry. */  
    __u32 tcpi_last_data_recv; /* 最近一次接收数据包在多久之前 */  
    __u32 tcpi_last_ack_recv; /* 最近一次接收 ACK 包在多久之前 */  
  
    /* Metrics. */  
    __u32 tcpi_pmtu; /* 最后一次更新的路径 MTU */  
    __u32 tcpi_rcv_ssthresh; /* current window clamp，rcv_wnd 的阈值 */  
    __u32 tcpi_rtt; /* 平滑的 RTT，单位为微秒 */  
    __u32 tcpi_rttvar; /* 四分之一 mdev，单位为微秒 */  
    __u32 tcpi_snd_ssthresh; /* 慢启动阈值 */  
    __u32 tcpi_snd_cwnd; /* 拥塞窗口 */  
    __u32 tcpi_advmss; /* 本端能接受的 MSS 上限，在建立连接时用来通告对端 */  
    __u32 tcpi_reordering; /* 没有丢包时，可以重新排序的数据段数 */  
  
    __u32 tcpi_rcv_rtt; /* 作为接收端，测出的 RTT 值，单位为微秒 */  
    __u32 tcpi_rcv_space;  /* 当前接收缓存的大小 */  
  
    __u32 tcpi_total_retrans; /* 本连接的总重传个数 */  
}; 
```

在《[Measuring TCP Congestion Windows](https://linuxgazette.net/136/pfeiffer.html)》中主要介绍了

- 为何不使用 `tcpprobe` (`kprobes`) ，而使用 `getsockopt()` 获取 TCP_INFO 信息的原因；
- 基于 C 实现的源码（重点关注）；
- 针对 TCP_INFO 中一些字段的说明；
- 防止内核在多次测试间保存 metrics 信息而导致测试不准确的内核参数；





## 参考

- 《[关于tcp listen queue的一点事](https://www.douban.com/note/178129553/)》
- 《[TCP connection backlog - a struggling server](https://bunn.cc/2017/syn-backlog/)》
- 《[getsockopt的TCP层实现剖析](http://blog.csdn.net/zhangskd/article/details/8561950)》
- 《[Measuring TCP Congestion Windows](https://linuxgazette.net/136/pfeiffer.html)》
- 《[Two great signals: SIGSTOP and SIGCONT](https://major.io/2009/06/15/two-great-signals-sigstop-and-sigcont/)》
- 《[netperf 与网络性能测量](https://www.ibm.com/developerworks/cn/linux/l-netperf/)》
- 《[Azure 中使用 iPerf 进行网络带宽测试](https://docs.azure.cn/zh-cn/articles/azure-operations-guide/virtual-network/aog-virtual-network-iperf-bandwidth-test)》
- http://httpd.apache.org/docs/current/programs/ab.html




