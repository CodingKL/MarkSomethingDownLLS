# prometheus 线上环境 fd 超限问题排查

## 系统表现

prometheus 无法正常显示指标信息；

## 登录方式

```
ssh deployer@172.31.4.6
```

## 系统信息

```
root@prometheus-prod:~# uname -a
Linux prometheus-prod 4.4.0-62-generic #83-Ubuntu SMP Wed Jan 18 14:10:15 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux
root@prometheus-prod:~# lsb_release -a
No LSB modules are available.
Distributor ID:	Ubuntu
Description:	Ubuntu 16.04.1 LTS
Release:	16.04
Codename:	xenial
root@prometheus-prod:~# ifconfig
ens3      Link encap:Ethernet  HWaddr 02:74:27:33:c5:c8
          inet addr:172.31.4.6  Bcast:172.31.15.255  Mask:255.255.240.0
          inet6 addr: fe80::74:27ff:fe33:c5c8/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:9001  Metric:1
          RX packets:2027257313 errors:0 dropped:0 overruns:0 frame:0
          TX packets:1568785502 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:6900152947569 (6.9 TB)  TX bytes:195011270852 (195.0 GB)

lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:61102132 errors:0 dropped:0 overruns:0 frame:0
          TX packets:61102132 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1
          RX bytes:77594915863 (77.5 GB)  TX bytes:77594915863 (77.5 GB)

root@prometheus-prod:~#
```

## 系统参数


```
fs.file-max = 2097152
net.core.somaxconn = 128
net.ipv4.tcp_max_syn_backlog = 1024
net.ipv4.tcp_abort_on_overflow = 0
net.ipv4.tcp_synack_retries = 5
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_tw_reuse = 0
net.ipv4.tcp_tw_recycle = 0
```


## 问题排查

- top

```
root@prometheus-prod:~# top -Hp 15902 -n 1
top - 07:14:18 up 69 days, 20:24,  2 users,  load average: 0.76, 0.76, 0.96
Threads:  19 total,   0 running,  19 sleeping,   0 stopped,   0 zombie
%Cpu(s):  7.4 us,  0.1 sy,  0.0 ni, 92.4 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem : 32946292 total, 18219620 free,  3850040 used, 10876632 buff/cache
KiB Swap:        0 total,        0 free,        0 used. 28330548 avail Mem

  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND
15913 root      20   0  0.208t 3.567g 155824 S  6.7 11.4   2:05.76 prometheus
15902 root      20   0  0.208t 3.567g 155824 S  0.0 11.4   0:00.05 prometheus
15904 root      20   0  0.208t 3.567g 155824 S  0.0 11.4   0:08.01 prometheus
15905 root      20   0  0.208t 3.567g 155824 S  0.0 11.4   0:00.00 prometheus
15906 root      20   0  0.208t 3.567g 155824 S  0.0 11.4   1:37.18 prometheus
15907 root      20   0  0.208t 3.567g 155824 S  0.0 11.4   1:55.42 prometheus
15908 root      20   0  0.208t 3.567g 155824 S  0.0 11.4   0:00.00 prometheus
15909 root      20   0  0.208t 3.567g 155824 S  0.0 11.4   1:50.65 prometheus
15910 root      20   0  0.208t 3.567g 155824 S  0.0 11.4   1:22.76 prometheus
15911 root      20   0  0.208t 3.567g 155824 S  0.0 11.4   1:34.83 prometheus
15912 root      20   0  0.208t 3.567g 155824 S  0.0 11.4   2:33.13 prometheus
15914 root      20   0  0.208t 3.567g 155824 S  0.0 11.4   0:50.06 prometheus
15915 root      20   0  0.208t 3.567g 155824 S  0.0 11.4   2:34.88 prometheus
15916 root      20   0  0.208t 3.567g 155824 S  0.0 11.4   2:15.16 prometheus
15917 root      20   0  0.208t 3.567g 155824 S  0.0 11.4   0:19.90 prometheus
15918 root      20   0  0.208t 3.567g 155824 S  0.0 11.4   1:43.45 prometheus
16285 root      20   0  0.208t 3.567g 155824 S  0.0 11.4   1:16.77 prometheus
16510 root      20   0  0.208t 3.567g 155824 S  0.0 11.4   0:36.19 prometheus
16567 root      20   0  0.208t 3.567g 155824 S  0.0 11.4   0:35.14 prometheus
```

- 网络连接

```
root@prometheus-prod:~# ss -na | awk '/^tcp/ {++S[$2]} END {for(a in S) print a, S[a]}'
SYN-RECV 2
LISTEN 9
ESTAB 595
LAST-ACK 2
SYN-SENT 3
TIME-WAIT 411
root@prometheus-prod:~#
root@prometheus-prod:~# ss -na | awk '/^tcp/ {++S[$2]} END {for(a in S) print a, S[a]}'
LISTEN 9
ESTAB 601
SYN-SENT 3
TIME-WAIT 917
root@prometheus-prod:~# ss -na | awk '/^tcp/ {++S[$2]} END {for(a in S) print a, S[a]}'
LISTEN 9
ESTAB 600
SYN-SENT 4
TIME-WAIT 917
root@prometheus-prod:~# ss -na | awk '/^tcp/ {++S[$2]} END {for(a in S) print a, S[a]}'
LISTEN 9
ESTAB 600
SYN-SENT 3
TIME-WAIT 917
root@prometheus-prod:~# ss -na | awk '/^tcp/ {++S[$2]} END {for(a in S) print a, S[a]}'
LISTEN 9
ESTAB 600
SYN-SENT 2
TIME-WAIT 917
root@prometheus-prod:~# ss -na | awk '/^tcp/ {++S[$2]} END {for(a in S) print a, S[a]}'
LISTEN 9
ESTAB 601
SYN-SENT 2
TIME-WAIT 917
root@prometheus-prod:~#
```

- 监听状况

```
root@prometheus-prod:~# ss -nltp | awk '{print $0}'
State      Recv-Q Send-Q Local Address:Port               Peer Address:Port
LISTEN     0      128          *:80                       *:*                   users:(("nginx",pid=17920,fd=13),("nginx",pid=17919,fd=13),("nginx",pid=17918,fd=13),("nginx",pid=17917,fd=13),("nginx",pid=17916,fd=13))
LISTEN     0      128          *:22                       *:*                   users:(("sshd",pid=1228,fd=3))
LISTEN     0      128          *:6783                     *:*                   users:(("alertmanager",pid=2097,fd=5))
LISTEN     0      128         :::9093                    :::*                   users:(("alertmanager",pid=2097,fd=3))
LISTEN     0      128         :::9100                    :::*                   users:(("node_exporter",pid=1240,fd=3))
LISTEN     0      128         :::22                      :::*                   users:(("sshd",pid=1228,fd=4))
LISTEN     0      128         :::3000                    :::*                   users:(("grafana-server",pid=24209,fd=6))
LISTEN     0      128         :::9090                    :::*                   users:(("prometheus",pid=22347,fd=3))
LISTEN     0      128         :::9091                    :::*                   users:(("pushgateway",pid=6983,fd=3))
root@prometheus-prod:~# ss -nltp | awk '{print $0}'
State      Recv-Q Send-Q Local Address:Port               Peer Address:Port
LISTEN     0      128          *:80                       *:*                   users:(("nginx",pid=17920,fd=13),("nginx",pid=17919,fd=13),("nginx",pid=17918,fd=13),("nginx",pid=17917,fd=13),("nginx",pid=17916,fd=13))
LISTEN     0      128          *:22                       *:*                   users:(("sshd",pid=1228,fd=3))
LISTEN     0      128          *:6783                     *:*                   users:(("alertmanager",pid=2097,fd=5))
LISTEN     0      128         :::9093                    :::*                   users:(("alertmanager",pid=2097,fd=3))
LISTEN     0      128         :::9100                    :::*                   users:(("node_exporter",pid=1240,fd=3))
LISTEN     0      128         :::22                      :::*                   users:(("sshd",pid=1228,fd=4))
LISTEN     0      128         :::3000                    :::*                   users:(("grafana-server",pid=24209,fd=6))
LISTEN     0      128         :::9090                    :::*                   users:(("prometheus",pid=22347,fd=3))
LISTEN     0      128         :::9091                    :::*                   users:(("pushgateway",pid=6983,fd=3))
root@prometheus-prod:~#
```

- Send-Q 和 Recv-Q 状况

```
root@prometheus-prod:~# netstat -antp| awk '{ if ($2 > 0 || $3 > 0) print $0 }'
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      1 172.31.4.6:54124        172.31.4.14:9100        SYN_SENT    22347/prometheus
tcp        0    356 172.31.4.6:22           172.31.10.66:52562      ESTABLISHED 13091/sshd: deploye
tcp        0      1 172.31.4.6:55728        172.31.1.18:9100        SYN_SENT    22347/prometheus
root@prometheus-prod:~# netstat -antp| awk '{ if ($2 > 0 || $3 > 0) print $0 }'
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0  98433 172.31.4.6:80           172.31.10.66:60278      ESTABLISHED 17918/nginx: worker
tcp        0      1 172.31.4.6:54124        172.31.4.14:9100        SYN_SENT    22347/prometheus
tcp        0      1 172.31.4.6:42130        172.31.10.149:9100      SYN_SENT    22347/prometheus
tcp        0    736 172.31.4.6:22           172.31.10.66:52562      ESTABLISHED 13091/sshd: deploye
tcp        0      1 172.31.4.6:55728        172.31.1.18:9100        SYN_SENT    22347/prometheus
root@prometheus-prod:~# netstat -antp| awk '{ if ($2 > 0 || $3 > 0) print $0 }'
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0 270680 172.31.4.6:80           172.31.10.66:60278      ESTABLISHED 17918/nginx: worker
tcp        0      1 172.31.4.6:54124        172.31.4.14:9100        SYN_SENT    22347/prometheus
tcp        0      1 172.31.4.6:42130        172.31.10.149:9100      SYN_SENT    22347/prometheus
tcp        0    664 172.31.4.6:22           172.31.10.66:52562      ESTABLISHED 13091/sshd: deploye
tcp        0      1 172.31.4.6:55728        172.31.1.18:9100        SYN_SENT    22347/prometheus
tcp        0    229 172.31.4.6:39786        172.1.48.191:10250      ESTABLISHED 22347/prometheus
root@prometheus-prod:~# netstat -antp| awk '{ if ($2 > 0 || $3 > 0) print $0 }'
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0     42 172.31.4.6:41484        172.1.55.130:443        ESTABLISHED 22347/prometheus
tcp        0      1 172.31.4.6:54124        172.31.4.14:9100        SYN_SENT    22347/prometheus
tcp        0  56012 172.31.4.6:80           172.31.10.66:60367      ESTABLISHED 17918/nginx: worker
tcp        0      1 172.31.4.6:59934        172.31.4.131:9100       SYN_SENT    22347/prometheus
tcp        0 171520 172.31.4.6:80           172.31.10.66:60352      ESTABLISHED 17917/nginx: worker
tcp        0      1 172.31.4.6:42130        172.31.10.149:9100      SYN_SENT    22347/prometheus
tcp        0   1004 172.31.4.6:22           172.31.10.66:52562      ESTABLISHED 13091/sshd: deploye
tcp        0      1 172.31.4.6:55728        172.31.1.18:9100        SYN_SENT    22347/prometheus
root@prometheus-prod:~# netstat -antp| awk '{ if ($2 > 0 || $3 > 0) print $0 }'
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0 270680 172.31.4.6:80           172.31.10.66:60278      ESTABLISHED 17918/nginx: worker
tcp        0      1 172.31.4.6:54124        172.31.4.14:9100        SYN_SENT    22347/prometheus
tcp        0      1 172.31.4.6:59934        172.31.4.131:9100       SYN_SENT    22347/prometheus
tcp        0      1 172.31.4.6:42130        172.31.10.149:9100      SYN_SENT    22347/prometheus
tcp        0    760 172.31.4.6:22           172.31.10.66:52562      ESTABLISHED 13091/sshd: deploye
tcp        0      1 172.31.4.6:55728        172.31.1.18:9100        SYN_SENT    22347/prometheus
root@prometheus-prod:~# netstat -antp| awk '{ if ($2 > 0 || $3 > 0) print $0 }'
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0 270680 172.31.4.6:80           172.31.10.66:60278      ESTABLISHED 17918/nginx: worker
tcp        0      1 172.31.4.6:59934        172.31.4.131:9100       SYN_SENT    22347/prometheus
tcp        0      1 172.31.4.6:42130        172.31.10.149:9100      SYN_SENT    22347/prometheus
tcp        0    628 172.31.4.6:22           172.31.10.66:52562      ESTABLISHED 13091/sshd: deploye
tcp        0      1 172.31.4.6:55728        172.31.1.18:9100        SYN_SENT    22347/prometheus
root@prometheus-prod:~# netstat -antp| awk '{ if ($2 > 0 || $3 > 0) print $0 }'
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0 258808 172.31.4.6:80           172.31.10.66:60278      ESTABLISHED 17918/nginx: worker
tcp        0      1 172.31.4.6:59934        172.31.4.131:9100       SYN_SENT    22347/prometheus
tcp        0      1 172.31.4.6:42130        172.31.10.149:9100      SYN_SENT    22347/prometheus
tcp        0    628 172.31.4.6:22           172.31.10.66:52562      ESTABLISHED 13091/sshd: deploye
root@prometheus-prod:~# netstat -antp| awk '{ if ($2 > 0 || $3 > 0) print $0 }'
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0 258808 172.31.4.6:80           172.31.10.66:60278      ESTABLISHED 17918/nginx: worker
tcp        0      1 172.31.4.6:59934        172.31.4.131:9100       SYN_SENT    22347/prometheus
tcp        0    496 172.31.4.6:22           172.31.10.66:52562      ESTABLISHED 13091/sshd: deploye
root@prometheus-prod:~# netstat -antp| awk '{ if ($2 > 0 || $3 > 0) print $0 }'
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0 352564 172.31.4.6:80           172.31.10.66:60278      ESTABLISHED 17918/nginx: worker
tcp        0      1 172.31.4.6:54364        172.31.4.14:9100        SYN_SENT    22347/prometheus
tcp        0      1 172.31.4.6:59934        172.31.4.131:9100       SYN_SENT    22347/prometheus
tcp        0    628 172.31.4.6:22           172.31.10.66:52562      ESTABLISHED 13091/sshd: deploye
root@prometheus-prod:~# netstat -antp| awk '{ if ($2 > 0 || $3 > 0) print $0 }'
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      1 172.31.4.6:55872        172.31.1.18:9100        SYN_SENT    22347/prometheus
tcp        0      1 172.31.4.6:54364        172.31.4.14:9100        SYN_SENT    22347/prometheus
tcp        0    488 172.31.4.6:22           172.31.10.66:52562      ESTABLISHED 13091/sshd: deploye
tcp        0      1 172.31.4.6:42198        172.31.10.149:9100      SYN_SENT    22347/prometheus
root@prometheus-prod:~# netstat -antp| awk '{ if ($2 > 0 || $3 > 0) print $0 }'
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      1 172.31.4.6:54516        172.31.4.14:9100        SYN_SENT    22347/prometheus
tcp        0      1 172.31.4.6:56024        172.31.1.18:9100        SYN_SENT    22347/prometheus
tcp        0    460 172.31.4.6:22           172.31.10.66:52562      ESTABLISHED 13091/sshd: deploye
tcp        0    198 172.31.4.6:52692        172.31.3.89:9100        ESTABLISHED 22347/prometheus
root@prometheus-prod:~# netstat -antp| awk '{ if ($2 > 0 || $3 > 0) print $0 }'
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      1 172.31.4.6:54516        172.31.4.14:9100        SYN_SENT    22347/prometheus
tcp        0      1 172.31.4.6:56024        172.31.1.18:9100        SYN_SENT    22347/prometheus
tcp        0    460 172.31.4.6:22           172.31.10.66:52562      ESTABLISHED 13091/sshd: deploye
root@prometheus-prod:~#
```

- 基于 tcp 连接的 src ip 和 dst ip 进行统计

```
root@prometheus-prod:~# ss -tan | awk '{print $(NF-1)" "$(NF)}' | sed 's/:[^ ]*//g' | sort | uniq -c
     17
      3 * *
    200 127.0.0.1 127.0.0.1
      2 172.31.4.6 172.1.32.165
      2 172.31.4.6 172.1.32.224
      2 172.31.4.6 172.1.33.129
      2 172.31.4.6 172.1.33.21
      2 172.31.4.6 172.1.33.79
      2 172.31.4.6 172.1.34.34
      1 172.31.4.6 172.1.34.36
      2 172.31.4.6 172.1.34.55
      2 172.31.4.6 172.1.35.165
      1 172.31.4.6 172.1.35.166
      2 172.31.4.6 172.1.35.2
      2 172.31.4.6 172.1.36.11
      2 172.31.4.6 172.1.36.132
      2 172.31.4.6 172.1.36.150
      2 172.31.4.6 172.1.36.30
      2 172.31.4.6 172.1.36.43
      2 172.31.4.6 172.1.37.106
      2 172.31.4.6 172.1.37.107
      2 172.31.4.6 172.1.37.162
      2 172.31.4.6 172.1.38.108
      2 172.31.4.6 172.1.39.126
      2 172.31.4.6 172.1.39.237
      2 172.31.4.6 172.1.39.66
      1 172.31.4.6 172.1.40.192
      2 172.31.4.6 172.1.40.217
      2 172.31.4.6 172.1.40.92
      2 172.31.4.6 172.1.41.114
      2 172.31.4.6 172.1.41.215
      2 172.31.4.6 172.1.41.92
      2 172.31.4.6 172.1.42.14
      2 172.31.4.6 172.1.42.21
      2 172.31.4.6 172.1.42.238
      2 172.31.4.6 172.1.43.146
      2 172.31.4.6 172.1.43.2
      2 172.31.4.6 172.1.43.234
      2 172.31.4.6 172.1.43.33
      2 172.31.4.6 172.1.43.46
      2 172.31.4.6 172.1.44.135
      2 172.31.4.6 172.1.44.230
      2 172.31.4.6 172.1.44.234
      2 172.31.4.6 172.1.44.36
      2 172.31.4.6 172.1.44.48
      2 172.31.4.6 172.1.45.9
      2 172.31.4.6 172.1.46.240
      2 172.31.4.6 172.1.46.244
      2 172.31.4.6 172.1.47.41
      2 172.31.4.6 172.1.47.81
      2 172.31.4.6 172.1.48.164
      2 172.31.4.6 172.1.48.188
      2 172.31.4.6 172.1.48.191
      2 172.31.4.6 172.1.48.203
      2 172.31.4.6 172.1.48.39
      2 172.31.4.6 172.1.49.153
      2 172.31.4.6 172.1.50.116
      2 172.31.4.6 172.1.50.119
      2 172.31.4.6 172.1.50.19
      2 172.31.4.6 172.1.51.136
      2 172.31.4.6 172.1.52.100
      2 172.31.4.6 172.1.52.187
      2 172.31.4.6 172.1.53.167
      2 172.31.4.6 172.1.53.183
      2 172.31.4.6 172.1.53.68
      2 172.31.4.6 172.1.55.121
      2 172.31.4.6 172.1.55.130
      2 172.31.4.6 172.1.55.220
      2 172.31.4.6 172.1.55.247
      2 172.31.4.6 172.1.55.61
      2 172.31.4.6 172.1.55.83
      2 172.31.4.6 172.1.56.105
      2 172.31.4.6 172.1.56.178
      2 172.31.4.6 172.1.56.189
      2 172.31.4.6 172.1.56.22
      2 172.31.4.6 172.1.56.224
      2 172.31.4.6 172.1.56.8
      2 172.31.4.6 172.1.56.83
      2 172.31.4.6 172.1.56.92
      2 172.31.4.6 172.1.57.20
      2 172.31.4.6 172.1.57.200
      2 172.31.4.6 172.1.58.189
      2 172.31.4.6 172.1.58.80
      2 172.31.4.6 172.1.59.158
      2 172.31.4.6 172.1.59.187
      2 172.31.4.6 172.1.59.228
      2 172.31.4.6 172.1.59.239
      2 172.31.4.6 172.1.59.67
      2 172.31.4.6 172.1.60.55
      2 172.31.4.6 172.1.61.101
      2 172.31.4.6 172.1.61.102
      2 172.31.4.6 172.1.62.114
      2 172.31.4.6 172.1.62.116
      2 172.31.4.6 172.1.62.20
      2 172.31.4.6 172.1.63.221
      2 172.31.4.6 172.1.63.49
      2 172.31.4.6 172.1.63.70
      2 172.31.4.6 172.1.63.77
      1 172.31.4.6 172.3.36.206
      1 172.31.4.6 172.3.46.234
      1 172.31.4.6 172.3.57.24
      1 172.31.4.6 172.3.59.53
      1 172.31.4.6 172.31.0.105
      1 172.31.4.6 172.31.0.109
      1 172.31.4.6 172.31.0.128
      1 172.31.4.6 172.31.0.134
      1 172.31.4.6 172.31.0.138
      1 172.31.4.6 172.31.0.159
      1 172.31.4.6 172.31.0.164
      1 172.31.4.6 172.31.0.169
      1 172.31.4.6 172.31.0.17
      1 172.31.4.6 172.31.0.171
      1 172.31.4.6 172.31.0.174
      1 172.31.4.6 172.31.0.176
      1 172.31.4.6 172.31.0.203
      1 172.31.4.6 172.31.0.219
      1 172.31.4.6 172.31.0.231
      1 172.31.4.6 172.31.0.244
      1 172.31.4.6 172.31.0.32
      1 172.31.4.6 172.31.0.42
      1 172.31.4.6 172.31.0.59
      1 172.31.4.6 172.31.0.64
      1 172.31.4.6 172.31.0.65
      1 172.31.4.6 172.31.0.66
      2 172.31.4.6 172.31.0.7
      1 172.31.4.6 172.31.0.87
      1 172.31.4.6 172.31.0.9
      1 172.31.4.6 172.31.0.90
      1 172.31.4.6 172.31.1.119
      1 172.31.4.6 172.31.1.125
      1 172.31.4.6 172.31.1.132
      1 172.31.4.6 172.31.1.165
      1 172.31.4.6 172.31.1.201
      1 172.31.4.6 172.31.1.203
      1 172.31.4.6 172.31.1.225
      1 172.31.4.6 172.31.1.235
      2 172.31.4.6 172.31.1.240
      1 172.31.4.6 172.31.1.241
      1 172.31.4.6 172.31.1.253
      1 172.31.4.6 172.31.1.50
      1 172.31.4.6 172.31.1.64
      1 172.31.4.6 172.31.1.81
      1 172.31.4.6 172.31.1.87
      2 172.31.4.6 172.31.1.97
      1 172.31.4.6 172.31.10.1
      1 172.31.4.6 172.31.10.108
      1 172.31.4.6 172.31.10.110
      1 172.31.4.6 172.31.10.118
      1 172.31.4.6 172.31.10.130
      1 172.31.4.6 172.31.10.132
      1 172.31.4.6 172.31.10.149
      1 172.31.4.6 172.31.10.151
      2 172.31.4.6 172.31.10.189
      2 172.31.4.6 172.31.10.190
      2 172.31.4.6 172.31.10.191
      1 172.31.4.6 172.31.10.202
      1 172.31.4.6 172.31.10.205
      2 172.31.4.6 172.31.10.212
      1 172.31.4.6 172.31.10.234
      1 172.31.4.6 172.31.10.33
      1 172.31.4.6 172.31.10.39
      1 172.31.4.6 172.31.10.53
     20 172.31.4.6 172.31.10.66
      1 172.31.4.6 172.31.10.68
      1 172.31.4.6 172.31.10.75
      1 172.31.4.6 172.31.10.83
      1 172.31.4.6 172.31.10.86
      1 172.31.4.6 172.31.11.101
      2 172.31.4.6 172.31.11.113
      1 172.31.4.6 172.31.11.122
      1 172.31.4.6 172.31.11.124
      1 172.31.4.6 172.31.11.136
      2 172.31.4.6 172.31.11.140
      1 172.31.4.6 172.31.11.153
      1 172.31.4.6 172.31.11.159
      1 172.31.4.6 172.31.11.163
      1 172.31.4.6 172.31.11.186
      2 172.31.4.6 172.31.11.220
      1 172.31.4.6 172.31.11.226
      1 172.31.4.6 172.31.11.240
      1 172.31.4.6 172.31.11.244
      1 172.31.4.6 172.31.11.248
      1 172.31.4.6 172.31.11.254
      1 172.31.4.6 172.31.11.27
      1 172.31.4.6 172.31.11.29
      1 172.31.4.6 172.31.11.42
      1 172.31.4.6 172.31.11.49
      1 172.31.4.6 172.31.11.54
      1 172.31.4.6 172.31.11.59
      1 172.31.4.6 172.31.11.62
      1 172.31.4.6 172.31.11.79
      2 172.31.4.6 172.31.11.8
      1 172.31.4.6 172.31.11.80
      1 172.31.4.6 172.31.11.89
      1 172.31.4.6 172.31.11.91
      1 172.31.4.6 172.31.11.99
      1 172.31.4.6 172.31.12.121
      1 172.31.4.6 172.31.12.136
      1 172.31.4.6 172.31.12.140
      1 172.31.4.6 172.31.12.154
      1 172.31.4.6 172.31.12.156
      1 172.31.4.6 172.31.12.157
      1 172.31.4.6 172.31.12.18
      1 172.31.4.6 172.31.12.182
      1 172.31.4.6 172.31.12.193
      1 172.31.4.6 172.31.12.197
      1 172.31.4.6 172.31.12.235
      1 172.31.4.6 172.31.12.245
      2 172.31.4.6 172.31.12.249
      1 172.31.4.6 172.31.12.32
      1 172.31.4.6 172.31.12.75
      1 172.31.4.6 172.31.128.241
      1 172.31.4.6 172.31.13.102
      1 172.31.4.6 172.31.13.103
      1 172.31.4.6 172.31.13.13
      1 172.31.4.6 172.31.13.170
      1 172.31.4.6 172.31.13.173
      2 172.31.4.6 172.31.13.182
      1 172.31.4.6 172.31.13.189
      1 172.31.4.6 172.31.13.190
      1 172.31.4.6 172.31.13.196
      1 172.31.4.6 172.31.13.213
      1 172.31.4.6 172.31.13.214
      1 172.31.4.6 172.31.13.216
      1 172.31.4.6 172.31.13.248
      1 172.31.4.6 172.31.13.25
      1 172.31.4.6 172.31.13.250
      1 172.31.4.6 172.31.13.252
      1 172.31.4.6 172.31.13.33
      1 172.31.4.6 172.31.13.45
      1 172.31.4.6 172.31.13.5
      1 172.31.4.6 172.31.13.51
      1 172.31.4.6 172.31.13.62
      1 172.31.4.6 172.31.13.63
      1 172.31.4.6 172.31.13.93
     10 172.31.4.6 172.31.13.99
      1 172.31.4.6 172.31.130.119
      1 172.31.4.6 172.31.132.78
      1 172.31.4.6 172.31.136.27
      5 172.31.4.6 172.31.139.153
      1 172.31.4.6 172.31.139.230
      2 172.31.4.6 172.31.14.1
      1 172.31.4.6 172.31.14.100
      1 172.31.4.6 172.31.14.106
      1 172.31.4.6 172.31.14.110
      1 172.31.4.6 172.31.14.116
      1 172.31.4.6 172.31.14.121
      5 172.31.4.6 172.31.14.149
      1 172.31.4.6 172.31.14.15
      1 172.31.4.6 172.31.14.155
      1 172.31.4.6 172.31.14.156
      1 172.31.4.6 172.31.14.165
      1 172.31.4.6 172.31.14.210
      1 172.31.4.6 172.31.14.221
      1 172.31.4.6 172.31.14.24
      1 172.31.4.6 172.31.14.31
      2 172.31.4.6 172.31.14.7
      1 172.31.4.6 172.31.14.73
      1 172.31.4.6 172.31.14.80
      1 172.31.4.6 172.31.14.87
      1 172.31.4.6 172.31.15.103
      2 172.31.4.6 172.31.15.107
      1 172.31.4.6 172.31.15.111
      1 172.31.4.6 172.31.15.128
      1 172.31.4.6 172.31.15.180
      1 172.31.4.6 172.31.15.188
      1 172.31.4.6 172.31.15.200
      1 172.31.4.6 172.31.15.209
      1 172.31.4.6 172.31.15.211
      1 172.31.4.6 172.31.15.215
      1 172.31.4.6 172.31.15.217
      1 172.31.4.6 172.31.15.247
      1 172.31.4.6 172.31.15.250
      1 172.31.4.6 172.31.15.253
      1 172.31.4.6 172.31.15.44
      1 172.31.4.6 172.31.15.49
      1 172.31.4.6 172.31.15.59
      2 172.31.4.6 172.31.15.64
      1 172.31.4.6 172.31.15.92
      1 172.31.4.6 172.31.15.93
      1 172.31.4.6 172.31.15.96
      2 172.31.4.6 172.31.17.238
      2 172.31.4.6 172.31.17.239
      2 172.31.4.6 172.31.2.100
      1 172.31.4.6 172.31.2.116
      1 172.31.4.6 172.31.2.126
      1 172.31.4.6 172.31.2.133
      1 172.31.4.6 172.31.2.135
      1 172.31.4.6 172.31.2.139
      1 172.31.4.6 172.31.2.16
      1 172.31.4.6 172.31.2.175
      1 172.31.4.6 172.31.2.181
      2 172.31.4.6 172.31.2.205
      1 172.31.4.6 172.31.2.208
      1 172.31.4.6 172.31.2.229
      1 172.31.4.6 172.31.2.25
      1 172.31.4.6 172.31.2.252
      1 172.31.4.6 172.31.2.7
      1 172.31.4.6 172.31.2.80
      1 172.31.4.6 172.31.2.87
      1 172.31.4.6 172.31.2.91
      1 172.31.4.6 172.31.2.94
      1 172.31.4.6 172.31.2.99
      1 172.31.4.6 172.31.3.148
      1 172.31.4.6 172.31.3.160
      2 172.31.4.6 172.31.3.170
      1 172.31.4.6 172.31.3.218
      1 172.31.4.6 172.31.3.224
      2 172.31.4.6 172.31.3.225
      1 172.31.4.6 172.31.3.240
      1 172.31.4.6 172.31.3.43
      1 172.31.4.6 172.31.3.5
      2 172.31.4.6 172.31.3.56
      1 172.31.4.6 172.31.3.63
      1 172.31.4.6 172.31.3.79
      1 172.31.4.6 172.31.3.89
      1 172.31.4.6 172.31.4.10
      1 172.31.4.6 172.31.4.100
      3 172.31.4.6 172.31.4.102
      1 172.31.4.6 172.31.4.113
      1 172.31.4.6 172.31.4.118
      1 172.31.4.6 172.31.4.12
      1 172.31.4.6 172.31.4.131
      1 172.31.4.6 172.31.4.144
      1 172.31.4.6 172.31.4.16
      1 172.31.4.6 172.31.4.170
      1 172.31.4.6 172.31.4.193
      1 172.31.4.6 172.31.4.214
      1 172.31.4.6 172.31.4.218
      1 172.31.4.6 172.31.4.219
      1 172.31.4.6 172.31.4.221
      2 172.31.4.6 172.31.4.227
      1 172.31.4.6 172.31.4.234
      2 172.31.4.6 172.31.4.24
      1 172.31.4.6 172.31.4.249
      1 172.31.4.6 172.31.4.34
      1 172.31.4.6 172.31.4.55
      1 172.31.4.6 172.31.4.56
     43 172.31.4.6 172.31.4.6
      1 172.31.4.6 172.31.4.7
      1 172.31.4.6 172.31.4.81
      1 172.31.4.6 172.31.4.88
      1 172.31.4.6 172.31.4.96
      1 172.31.4.6 172.31.4.97
      1 172.31.4.6 172.31.5.102
      1 172.31.4.6 172.31.5.107
      1 172.31.4.6 172.31.5.11
      1 172.31.4.6 172.31.5.123
      1 172.31.4.6 172.31.5.124
      1 172.31.4.6 172.31.5.147
      1 172.31.4.6 172.31.5.148
      1 172.31.4.6 172.31.5.2
      1 172.31.4.6 172.31.5.233
      1 172.31.4.6 172.31.5.234
      1 172.31.4.6 172.31.5.24
      1 172.31.4.6 172.31.5.250
      1 172.31.4.6 172.31.5.31
      1 172.31.4.6 172.31.5.60
      1 172.31.4.6 172.31.5.71
      1 172.31.4.6 172.31.5.94
      1 172.31.4.6 172.31.6.102
      1 172.31.4.6 172.31.6.13
      2 172.31.4.6 172.31.6.140
      2 172.31.4.6 172.31.6.158
      1 172.31.4.6 172.31.6.168
      1 172.31.4.6 172.31.6.25
      1 172.31.4.6 172.31.6.254
      1 172.31.4.6 172.31.6.52
      1 172.31.4.6 172.31.6.53
      1 172.31.4.6 172.31.6.71
      1 172.31.4.6 172.31.6.77
      1 172.31.4.6 172.31.7.106
      1 172.31.4.6 172.31.7.107
      1 172.31.4.6 172.31.7.12
      1 172.31.4.6 172.31.7.147
      1 172.31.4.6 172.31.7.164
      1 172.31.4.6 172.31.7.174
      1 172.31.4.6 172.31.7.2
      1 172.31.4.6 172.31.7.204
      1 172.31.4.6 172.31.7.212
      1 172.31.4.6 172.31.7.235
      1 172.31.4.6 172.31.7.236
      3 172.31.4.6 172.31.7.239
      1 172.31.4.6 172.31.7.27
      1 172.31.4.6 172.31.7.62
      1 172.31.4.6 172.31.8.110
      1 172.31.4.6 172.31.8.127
      1 172.31.4.6 172.31.8.147
    224 172.31.4.6 172.31.8.150
      2 172.31.4.6 172.31.8.17
      1 172.31.4.6 172.31.8.173
      2 172.31.4.6 172.31.8.176
      1 172.31.4.6 172.31.8.19
      1 172.31.4.6 172.31.8.193
      1 172.31.4.6 172.31.8.194
      1 172.31.4.6 172.31.8.200
      1 172.31.4.6 172.31.8.225
      1 172.31.4.6 172.31.8.226
      1 172.31.4.6 172.31.8.242
      1 172.31.4.6 172.31.8.30
      1 172.31.4.6 172.31.8.57
      1 172.31.4.6 172.31.8.60
      1 172.31.4.6 172.31.9.10
      1 172.31.4.6 172.31.9.117
      1 172.31.4.6 172.31.9.120
      2 172.31.4.6 172.31.9.144
      2 172.31.4.6 172.31.9.169
      1 172.31.4.6 172.31.9.180
      1 172.31.4.6 172.31.9.190
      1 172.31.4.6 172.31.9.191
      1 172.31.4.6 172.31.9.203
      2 172.31.4.6 172.31.9.206
      1 172.31.4.6 172.31.9.216
      2 172.31.4.6 172.31.9.230
      1 172.31.4.6 172.31.9.242
      1 172.31.4.6 172.31.9.46
      1 172.31.4.6 172.31.9.5
      1 172.31.4.6 172.31.9.56
      1 172.31.4.6 172.31.9.63
      2 172.31.4.6 172.31.9.73
      1 172.31.4.6 172.31.9.75
      1 172.31.4.6 172.31.9.80
      1 172.31.4.6 172.31.9.9
      2 172.31.4.6 172.31.9.90
      1 172.31.4.6 172.31.9.97
      1 172.31.4.6 172.31.9.98
      2 172.31.4.6 54.222.134.70
      1 172.31.4.6 54.222.5.106
      1 Peer Address
root@prometheus-prod:~#
```


- 确定 tcp 连接本地随机端口使用情况分布

```
root@prometheus-prod:~# ss -tan | awk '{print $(NF-1)" "$(NF)}' | sed 's/:[^ ]* / /g' | sort | uniq -c
      1  ::1:60076
      1  ::1:9090
      6  :::*
      1  ::ffff:172.31.0.64:59005
      1  ::ffff:172.31.0.64:59007
      1  ::ffff:172.31.0.64:59009
      1  ::ffff:172.31.4.6:45042
      1  ::ffff:172.31.8.218:49294
      3 * *:*
     12 127.0.0.1 127.0.0.1:9090
      4 127.0.0.1 127.0.0.1:9091
     12 127.0.0.1 127.0.0.1:9093
      1 172.31.4.6 172.1.32.165:10250
      1 172.31.4.6 172.1.32.165:9100
      1 172.31.4.6 172.1.32.224:10250
      1 172.31.4.6 172.1.32.224:9100
      1 172.31.4.6 172.1.33.129:10250
      1 172.31.4.6 172.1.33.129:9100
      1 172.31.4.6 172.1.33.21:10250
      1 172.31.4.6 172.1.33.21:9100
      1 172.31.4.6 172.1.33.79:10250
      1 172.31.4.6 172.1.33.79:9100
      1 172.31.4.6 172.1.34.34:10250
      1 172.31.4.6 172.1.34.34:9100
      1 172.31.4.6 172.1.34.36:9100
      1 172.31.4.6 172.1.34.55:10250
      1 172.31.4.6 172.1.34.55:9100
      1 172.31.4.6 172.1.35.165:10250
      1 172.31.4.6 172.1.35.165:9100
      1 172.31.4.6 172.1.35.166:9100
      1 172.31.4.6 172.1.35.2:10250
      1 172.31.4.6 172.1.35.2:9100
      1 172.31.4.6 172.1.36.11:10250
      1 172.31.4.6 172.1.36.11:9100
      1 172.31.4.6 172.1.36.132:10250
      1 172.31.4.6 172.1.36.132:9100
      1 172.31.4.6 172.1.36.150:10250
      1 172.31.4.6 172.1.36.150:9100
      1 172.31.4.6 172.1.36.30:10250
      1 172.31.4.6 172.1.36.30:9100
      1 172.31.4.6 172.1.36.43:10250
      1 172.31.4.6 172.1.36.43:9100
      1 172.31.4.6 172.1.37.106:10250
      1 172.31.4.6 172.1.37.106:9100
      1 172.31.4.6 172.1.37.107:10250
      1 172.31.4.6 172.1.37.107:9100
      1 172.31.4.6 172.1.37.162:10250
      1 172.31.4.6 172.1.37.162:9100
      1 172.31.4.6 172.1.38.108:10250
      1 172.31.4.6 172.1.38.108:9100
      1 172.31.4.6 172.1.39.126:10250
      1 172.31.4.6 172.1.39.126:9100
      1 172.31.4.6 172.1.39.237:10250
      1 172.31.4.6 172.1.39.237:9100
      1 172.31.4.6 172.1.39.66:10250
      1 172.31.4.6 172.1.39.66:9100
      1 172.31.4.6 172.1.40.192:9100
      1 172.31.4.6 172.1.40.217:10250
      1 172.31.4.6 172.1.40.217:9100
      1 172.31.4.6 172.1.40.92:10250
      1 172.31.4.6 172.1.40.92:9100
      1 172.31.4.6 172.1.41.114:10250
      1 172.31.4.6 172.1.41.114:9100
      1 172.31.4.6 172.1.41.215:10250
      1 172.31.4.6 172.1.41.215:9100
      1 172.31.4.6 172.1.41.92:10250
      1 172.31.4.6 172.1.41.92:9100
      1 172.31.4.6 172.1.42.14:10250
      1 172.31.4.6 172.1.42.14:9100
      1 172.31.4.6 172.1.42.21:10250
      1 172.31.4.6 172.1.42.21:9100
      1 172.31.4.6 172.1.42.238:10250
      1 172.31.4.6 172.1.42.238:9100
      1 172.31.4.6 172.1.43.146:10250
      1 172.31.4.6 172.1.43.146:9100
      1 172.31.4.6 172.1.43.234:10250
      1 172.31.4.6 172.1.43.234:9100
      1 172.31.4.6 172.1.43.2:10250
      1 172.31.4.6 172.1.43.2:9100
      1 172.31.4.6 172.1.43.33:10250
      1 172.31.4.6 172.1.43.33:9100
      1 172.31.4.6 172.1.43.46:10250
      1 172.31.4.6 172.1.43.46:9100
      1 172.31.4.6 172.1.44.135:10250
      1 172.31.4.6 172.1.44.135:9100
      1 172.31.4.6 172.1.44.230:10250
      1 172.31.4.6 172.1.44.230:9100
      1 172.31.4.6 172.1.44.234:10250
      1 172.31.4.6 172.1.44.234:9100
      1 172.31.4.6 172.1.44.36:10250
      1 172.31.4.6 172.1.44.36:9100
      1 172.31.4.6 172.1.44.48:10250
      1 172.31.4.6 172.1.44.48:9100
      1 172.31.4.6 172.1.45.9:10250
      1 172.31.4.6 172.1.45.9:9100
      1 172.31.4.6 172.1.46.240:10250
      1 172.31.4.6 172.1.46.240:9100
      1 172.31.4.6 172.1.46.244:10250
      1 172.31.4.6 172.1.46.244:9100
      1 172.31.4.6 172.1.47.41:10250
      1 172.31.4.6 172.1.47.41:9100
      1 172.31.4.6 172.1.47.81:10250
      1 172.31.4.6 172.1.47.81:9100
      1 172.31.4.6 172.1.48.164:10250
      1 172.31.4.6 172.1.48.164:9100
      1 172.31.4.6 172.1.48.188:10250
      1 172.31.4.6 172.1.48.188:9100
      1 172.31.4.6 172.1.48.191:10250
      1 172.31.4.6 172.1.48.191:9100
      1 172.31.4.6 172.1.48.203:10250
      1 172.31.4.6 172.1.48.203:9100
      1 172.31.4.6 172.1.48.39:10250
      1 172.31.4.6 172.1.48.39:9100
      1 172.31.4.6 172.1.49.153:10250
      1 172.31.4.6 172.1.49.153:9100
      1 172.31.4.6 172.1.50.116:10250
      1 172.31.4.6 172.1.50.116:9100
      1 172.31.4.6 172.1.50.119:10250
      1 172.31.4.6 172.1.50.119:9100
      1 172.31.4.6 172.1.50.19:10250
      1 172.31.4.6 172.1.50.19:9100
      1 172.31.4.6 172.1.51.136:10250
      1 172.31.4.6 172.1.51.136:9100
      1 172.31.4.6 172.1.52.100:10250
      1 172.31.4.6 172.1.52.100:9100
      1 172.31.4.6 172.1.52.187:10250
      1 172.31.4.6 172.1.52.187:9100
      1 172.31.4.6 172.1.53.167:10250
      1 172.31.4.6 172.1.53.167:9100
      1 172.31.4.6 172.1.53.183:10250
      1 172.31.4.6 172.1.53.183:9100
      1 172.31.4.6 172.1.53.68:10250
      1 172.31.4.6 172.1.53.68:9100
      1 172.31.4.6 172.1.55.121:10250
      1 172.31.4.6 172.1.55.121:9100
      1 172.31.4.6 172.1.55.130:443
      1 172.31.4.6 172.1.55.130:9100
      1 172.31.4.6 172.1.55.220:10250
      1 172.31.4.6 172.1.55.220:9100
      1 172.31.4.6 172.1.55.247:10250
      1 172.31.4.6 172.1.55.247:9100
      1 172.31.4.6 172.1.55.61:10250
      1 172.31.4.6 172.1.55.61:9100
      1 172.31.4.6 172.1.55.83:10250
      1 172.31.4.6 172.1.55.83:9100
      1 172.31.4.6 172.1.56.105:10250
      1 172.31.4.6 172.1.56.105:9100
      1 172.31.4.6 172.1.56.178:10250
      1 172.31.4.6 172.1.56.178:9100
      1 172.31.4.6 172.1.56.189:10250
      1 172.31.4.6 172.1.56.189:9100
      1 172.31.4.6 172.1.56.224:10250
      1 172.31.4.6 172.1.56.224:9100
      1 172.31.4.6 172.1.56.22:10250
      1 172.31.4.6 172.1.56.22:9100
      1 172.31.4.6 172.1.56.83:10250
      1 172.31.4.6 172.1.56.83:9100
      1 172.31.4.6 172.1.56.8:10250
      1 172.31.4.6 172.1.56.8:9100
      1 172.31.4.6 172.1.56.92:10250
      1 172.31.4.6 172.1.56.92:9100
      1 172.31.4.6 172.1.57.200:10250
      1 172.31.4.6 172.1.57.200:9100
      1 172.31.4.6 172.1.57.20:10250
      1 172.31.4.6 172.1.57.20:9100
      1 172.31.4.6 172.1.58.189:10250
      1 172.31.4.6 172.1.58.189:9100
      1 172.31.4.6 172.1.58.80:10250
      1 172.31.4.6 172.1.58.80:9100
      1 172.31.4.6 172.1.59.158:10250
      1 172.31.4.6 172.1.59.158:9100
      1 172.31.4.6 172.1.59.187:10250
      1 172.31.4.6 172.1.59.187:9100
      1 172.31.4.6 172.1.59.228:10250
      1 172.31.4.6 172.1.59.228:9100
      1 172.31.4.6 172.1.59.239:10250
      1 172.31.4.6 172.1.59.239:9100
      1 172.31.4.6 172.1.59.67:10250
      1 172.31.4.6 172.1.59.67:9100
      1 172.31.4.6 172.1.60.55:10250
      1 172.31.4.6 172.1.60.55:9100
      1 172.31.4.6 172.1.61.101:10250
      1 172.31.4.6 172.1.61.101:9100
      1 172.31.4.6 172.1.61.102:10250
      1 172.31.4.6 172.1.61.102:9100
      1 172.31.4.6 172.1.62.114:10250
      1 172.31.4.6 172.1.62.114:9100
      1 172.31.4.6 172.1.62.116:10250
      1 172.31.4.6 172.1.62.116:9100
      1 172.31.4.6 172.1.62.20:10250
      1 172.31.4.6 172.1.62.20:9100
      1 172.31.4.6 172.1.63.221:10250
      1 172.31.4.6 172.1.63.221:9100
      1 172.31.4.6 172.1.63.49:10250
      1 172.31.4.6 172.1.63.49:9100
      1 172.31.4.6 172.1.63.70:10250
      1 172.31.4.6 172.1.63.70:9100
      1 172.31.4.6 172.1.63.77:10250
      1 172.31.4.6 172.1.63.77:9100
      1 172.31.4.6 172.3.36.206:9100
      1 172.31.4.6 172.3.46.234:9100
      1 172.31.4.6 172.3.57.24:9100
      1 172.31.4.6 172.3.59.53:9100
      1 172.31.4.6 172.31.0.105:9100
      1 172.31.4.6 172.31.0.109:9100
      1 172.31.4.6 172.31.0.128:9100
      1 172.31.4.6 172.31.0.134:9100
      1 172.31.4.6 172.31.0.138:9100
      1 172.31.4.6 172.31.0.159:9100
      1 172.31.4.6 172.31.0.164:9100
      1 172.31.4.6 172.31.0.169:9100
      1 172.31.4.6 172.31.0.171:9100
      1 172.31.4.6 172.31.0.174:9100
      1 172.31.4.6 172.31.0.176:9100
      1 172.31.4.6 172.31.0.17:9100
      1 172.31.4.6 172.31.0.203:9100
      1 172.31.4.6 172.31.0.219:9100
      1 172.31.4.6 172.31.0.231:9100
      1 172.31.4.6 172.31.0.244:9100
      1 172.31.4.6 172.31.0.32:9100
      1 172.31.4.6 172.31.0.42:9100
      1 172.31.4.6 172.31.0.59:9100
      1 172.31.4.6 172.31.0.64:9100
      1 172.31.4.6 172.31.0.65:9100
      1 172.31.4.6 172.31.0.66:9100
      1 172.31.4.6 172.31.0.7:23333
      1 172.31.4.6 172.31.0.7:9100
      1 172.31.4.6 172.31.0.87:9100
      1 172.31.4.6 172.31.0.90:9100
      1 172.31.4.6 172.31.0.9:9100
      1 172.31.4.6 172.31.1.119:9100
      1 172.31.4.6 172.31.1.125:9100
      1 172.31.4.6 172.31.1.132:9100
      1 172.31.4.6 172.31.1.165:9100
      1 172.31.4.6 172.31.1.201:9100
      1 172.31.4.6 172.31.1.203:9100
      1 172.31.4.6 172.31.1.225:9100
      1 172.31.4.6 172.31.1.235:9100
      1 172.31.4.6 172.31.1.240:23333
      1 172.31.4.6 172.31.1.240:9100
      1 172.31.4.6 172.31.1.241:9100
      1 172.31.4.6 172.31.1.253:9100
      1 172.31.4.6 172.31.1.50:9100
      1 172.31.4.6 172.31.1.64:9100
      1 172.31.4.6 172.31.1.81:9100
      1 172.31.4.6 172.31.1.87:9100
      1 172.31.4.6 172.31.1.97:9100
      1 172.31.4.6 172.31.1.97:9200
      1 172.31.4.6 172.31.10.108:9100
      1 172.31.4.6 172.31.10.110:9100
      1 172.31.4.6 172.31.10.118:9100
      1 172.31.4.6 172.31.10.130:9100
      1 172.31.4.6 172.31.10.132:9100
      1 172.31.4.6 172.31.10.149:9100
      1 172.31.4.6 172.31.10.151:9100
      1 172.31.4.6 172.31.10.189:23333
      1 172.31.4.6 172.31.10.189:9100
      1 172.31.4.6 172.31.10.190:23333
      1 172.31.4.6 172.31.10.190:9100
      1 172.31.4.6 172.31.10.191:23333
      1 172.31.4.6 172.31.10.191:9100
      1 172.31.4.6 172.31.10.1:9100
      1 172.31.4.6 172.31.10.202:9100
      1 172.31.4.6 172.31.10.205:9100
      1 172.31.4.6 172.31.10.212:23333
      1 172.31.4.6 172.31.10.212:9100
      1 172.31.4.6 172.31.10.234:9100
      1 172.31.4.6 172.31.10.33:9100
      1 172.31.4.6 172.31.10.39:9100
      1 172.31.4.6 172.31.10.53:9100
      1 172.31.4.6 172.31.10.66:52554
      1 172.31.4.6 172.31.10.66:52562
      1 172.31.4.6 172.31.10.66:54023
      1 172.31.4.6 172.31.10.66:54024
      1 172.31.4.6 172.31.10.66:54025
      1 172.31.4.6 172.31.10.66:54026
      1 172.31.4.6 172.31.10.66:54027
      1 172.31.4.6 172.31.10.66:54028
      1 172.31.4.6 172.31.10.66:9100
      1 172.31.4.6 172.31.10.68:9100
      1 172.31.4.6 172.31.10.75:9100
      1 172.31.4.6 172.31.10.83:9100
      1 172.31.4.6 172.31.10.86:9100
      1 172.31.4.6 172.31.11.101:9100
      1 172.31.4.6 172.31.11.113:23333
      1 172.31.4.6 172.31.11.113:9100
      1 172.31.4.6 172.31.11.122:9100
      1 172.31.4.6 172.31.11.124:9100
      1 172.31.4.6 172.31.11.136:9100
      1 172.31.4.6 172.31.11.140:23333
      1 172.31.4.6 172.31.11.140:9100
      1 172.31.4.6 172.31.11.153:9100
      1 172.31.4.6 172.31.11.159:9100
      1 172.31.4.6 172.31.11.163:9100
      1 172.31.4.6 172.31.11.186:9100
      1 172.31.4.6 172.31.11.220:23333
      1 172.31.4.6 172.31.11.220:9100
      1 172.31.4.6 172.31.11.226:9100
      1 172.31.4.6 172.31.11.240:9100
      1 172.31.4.6 172.31.11.244:9100
      1 172.31.4.6 172.31.11.248:9100
      1 172.31.4.6 172.31.11.254:9100
      1 172.31.4.6 172.31.11.27:9100
      1 172.31.4.6 172.31.11.29:9100
      1 172.31.4.6 172.31.11.42:9100
      1 172.31.4.6 172.31.11.49:9100
      1 172.31.4.6 172.31.11.54:9100
      1 172.31.4.6 172.31.11.59:9100
      1 172.31.4.6 172.31.11.62:9100
      1 172.31.4.6 172.31.11.79:9100
      1 172.31.4.6 172.31.11.80:9100
      1 172.31.4.6 172.31.11.89:9100
      1 172.31.4.6 172.31.11.8:23333
      1 172.31.4.6 172.31.11.8:9100
      1 172.31.4.6 172.31.11.91:9100
      1 172.31.4.6 172.31.11.99:9100
      1 172.31.4.6 172.31.12.121:9100
      1 172.31.4.6 172.31.12.136:9100
      1 172.31.4.6 172.31.12.140:9100
      1 172.31.4.6 172.31.12.154:9100
      1 172.31.4.6 172.31.12.156:9100
      1 172.31.4.6 172.31.12.157:9100
      1 172.31.4.6 172.31.12.182:9100
      1 172.31.4.6 172.31.12.18:9100
      1 172.31.4.6 172.31.12.193:9100
      1 172.31.4.6 172.31.12.197:9100
      1 172.31.4.6 172.31.12.235:9100
      1 172.31.4.6 172.31.12.245:9100
      1 172.31.4.6 172.31.12.249:23334
      1 172.31.4.6 172.31.12.249:9100
      1 172.31.4.6 172.31.12.32:9100
      1 172.31.4.6 172.31.12.75:9100
      1 172.31.4.6 172.31.128.241:9100
      1 172.31.4.6 172.31.13.102:9100
      1 172.31.4.6 172.31.13.103:9100
      1 172.31.4.6 172.31.13.13:9100
      1 172.31.4.6 172.31.13.170:9100
      1 172.31.4.6 172.31.13.173:9100
      1 172.31.4.6 172.31.13.182:23334
      1 172.31.4.6 172.31.13.182:9100
      1 172.31.4.6 172.31.13.189:9100
      1 172.31.4.6 172.31.13.190:9100
      1 172.31.4.6 172.31.13.196:9100
      1 172.31.4.6 172.31.13.213:9100
      1 172.31.4.6 172.31.13.214:9100
      1 172.31.4.6 172.31.13.216:9100
      1 172.31.4.6 172.31.13.248:9100
      1 172.31.4.6 172.31.13.250:9100
      1 172.31.4.6 172.31.13.252:9100
      1 172.31.4.6 172.31.13.25:9100
      1 172.31.4.6 172.31.13.33:9100
      1 172.31.4.6 172.31.13.45:9100
      1 172.31.4.6 172.31.13.51:9100
      1 172.31.4.6 172.31.13.5:9100
      1 172.31.4.6 172.31.13.62:9100
      1 172.31.4.6 172.31.13.63:9100
      1 172.31.4.6 172.31.13.93:9100
      1 172.31.4.6 172.31.13.99:80
      1 172.31.4.6 172.31.130.119:9100
      1 172.31.4.6 172.31.132.78:9100
      1 172.31.4.6 172.31.136.27:9100
      1 172.31.4.6 172.31.139.230:9100
      1 172.31.4.6 172.31.14.100:9100
      1 172.31.4.6 172.31.14.106:9100
      1 172.31.4.6 172.31.14.110:9100
      1 172.31.4.6 172.31.14.116:9100
      1 172.31.4.6 172.31.14.121:9100
      1 172.31.4.6 172.31.14.149:23333
      1 172.31.4.6 172.31.14.149:23334
      1 172.31.4.6 172.31.14.149:23335
      1 172.31.4.6 172.31.14.149:23336
      1 172.31.4.6 172.31.14.149:9100
      1 172.31.4.6 172.31.14.155:9100
      1 172.31.4.6 172.31.14.156:9100
      1 172.31.4.6 172.31.14.15:9100
      1 172.31.4.6 172.31.14.165:9100
      1 172.31.4.6 172.31.14.1:23333
      1 172.31.4.6 172.31.14.1:9100
      1 172.31.4.6 172.31.14.210:9100
      1 172.31.4.6 172.31.14.221:9100
      1 172.31.4.6 172.31.14.24:9100
      1 172.31.4.6 172.31.14.31:9100
      1 172.31.4.6 172.31.14.73:9100
      1 172.31.4.6 172.31.14.7:23333
      1 172.31.4.6 172.31.14.7:9100
      1 172.31.4.6 172.31.14.80:9100
      1 172.31.4.6 172.31.14.87:9100
      1 172.31.4.6 172.31.15.103:9100
      1 172.31.4.6 172.31.15.107:23333
      1 172.31.4.6 172.31.15.107:9100
      1 172.31.4.6 172.31.15.111:9100
      1 172.31.4.6 172.31.15.128:9100
      1 172.31.4.6 172.31.15.180:9100
      1 172.31.4.6 172.31.15.188:9100
      1 172.31.4.6 172.31.15.200:9100
      1 172.31.4.6 172.31.15.209:9100
      1 172.31.4.6 172.31.15.211:9100
      1 172.31.4.6 172.31.15.215:9100
      1 172.31.4.6 172.31.15.217:9100
      1 172.31.4.6 172.31.15.247:9100
      1 172.31.4.6 172.31.15.250:9100
      1 172.31.4.6 172.31.15.253:9100
      1 172.31.4.6 172.31.15.44:9100
      1 172.31.4.6 172.31.15.49:9100
      1 172.31.4.6 172.31.15.59:9100
      1 172.31.4.6 172.31.15.64:23333
      1 172.31.4.6 172.31.15.64:9100
      1 172.31.4.6 172.31.15.92:9100
      1 172.31.4.6 172.31.15.93:9100
      1 172.31.4.6 172.31.15.96:9100
      1 172.31.4.6 172.31.17.238:23333
      1 172.31.4.6 172.31.17.238:9100
      1 172.31.4.6 172.31.17.239:23333
      1 172.31.4.6 172.31.17.239:9100
      1 172.31.4.6 172.31.2.100:9100
      1 172.31.4.6 172.31.2.100:9200
      1 172.31.4.6 172.31.2.116:9100
      1 172.31.4.6 172.31.2.126:9100
      1 172.31.4.6 172.31.2.133:9100
      1 172.31.4.6 172.31.2.135:9100
      1 172.31.4.6 172.31.2.139:9100
      1 172.31.4.6 172.31.2.16:9100
      1 172.31.4.6 172.31.2.175:9100
      1 172.31.4.6 172.31.2.181:9100
      1 172.31.4.6 172.31.2.205:23333
      1 172.31.4.6 172.31.2.205:9100
      1 172.31.4.6 172.31.2.208:9100
      1 172.31.4.6 172.31.2.229:9100
      1 172.31.4.6 172.31.2.252:9100
      1 172.31.4.6 172.31.2.25:9100
      1 172.31.4.6 172.31.2.7:9100
      1 172.31.4.6 172.31.2.80:9100
      1 172.31.4.6 172.31.2.87:9100
      1 172.31.4.6 172.31.2.91:9100
      1 172.31.4.6 172.31.2.94:9100
      1 172.31.4.6 172.31.2.99:9100
      1 172.31.4.6 172.31.3.148:9100
      1 172.31.4.6 172.31.3.160:9100
      1 172.31.4.6 172.31.3.170:23334
      1 172.31.4.6 172.31.3.170:9100
      1 172.31.4.6 172.31.3.218:9100
      1 172.31.4.6 172.31.3.224:9100
      1 172.31.4.6 172.31.3.225:23333
      1 172.31.4.6 172.31.3.225:9100
      1 172.31.4.6 172.31.3.240:9100
      1 172.31.4.6 172.31.3.43:9100
      1 172.31.4.6 172.31.3.56:23333
      1 172.31.4.6 172.31.3.56:9100
      1 172.31.4.6 172.31.3.5:9100
      1 172.31.4.6 172.31.3.63:9100
      1 172.31.4.6 172.31.3.79:9100
      1 172.31.4.6 172.31.3.89:9100
      1 172.31.4.6 172.31.4.100:9100
      1 172.31.4.6 172.31.4.102:23333
      1 172.31.4.6 172.31.4.102:23334
      1 172.31.4.6 172.31.4.102:9100
      1 172.31.4.6 172.31.4.10:9100
      1 172.31.4.6 172.31.4.113:9100
      1 172.31.4.6 172.31.4.118:9100
      1 172.31.4.6 172.31.4.12:9100
      1 172.31.4.6 172.31.4.131:9100
      1 172.31.4.6 172.31.4.144:9100
      1 172.31.4.6 172.31.4.16:9100
      1 172.31.4.6 172.31.4.170:9100
      1 172.31.4.6 172.31.4.193:9100
      1 172.31.4.6 172.31.4.214:9100
      1 172.31.4.6 172.31.4.218:9100
      1 172.31.4.6 172.31.4.219:9100
      1 172.31.4.6 172.31.4.221:9100
      1 172.31.4.6 172.31.4.227:23334
      1 172.31.4.6 172.31.4.227:9100
      1 172.31.4.6 172.31.4.234:9100
      1 172.31.4.6 172.31.4.249:9100
      1 172.31.4.6 172.31.4.24:23333
      1 172.31.4.6 172.31.4.24:9100
      1 172.31.4.6 172.31.4.34:9100
      1 172.31.4.6 172.31.4.55:9100
      1 172.31.4.6 172.31.4.56:9100
      1 172.31.4.6 172.31.4.6:57218
      1 172.31.4.6 172.31.4.6:57226
      1 172.31.4.6 172.31.4.6:60848
     11 172.31.4.6 172.31.4.6:80
      1 172.31.4.6 172.31.4.6:9100
      1 172.31.4.6 172.31.4.7:9100
      1 172.31.4.6 172.31.4.81:9100
      1 172.31.4.6 172.31.4.88:9100
      1 172.31.4.6 172.31.4.96:9100
      1 172.31.4.6 172.31.4.97:9100
      1 172.31.4.6 172.31.5.102:9100
      1 172.31.4.6 172.31.5.107:9100
      1 172.31.4.6 172.31.5.11:9100
      1 172.31.4.6 172.31.5.123:9100
      1 172.31.4.6 172.31.5.124:9100
      1 172.31.4.6 172.31.5.147:9100
      1 172.31.4.6 172.31.5.148:9100
      1 172.31.4.6 172.31.5.233:9100
      1 172.31.4.6 172.31.5.234:9100
      1 172.31.4.6 172.31.5.24:9100
      1 172.31.4.6 172.31.5.250:9100
      1 172.31.4.6 172.31.5.2:9100
      1 172.31.4.6 172.31.5.31:9100
      1 172.31.4.6 172.31.5.60:9100
      1 172.31.4.6 172.31.5.71:9100
      1 172.31.4.6 172.31.5.94:9100
      1 172.31.4.6 172.31.6.102:9100
      1 172.31.4.6 172.31.6.13:9100
      1 172.31.4.6 172.31.6.140:23334
      1 172.31.4.6 172.31.6.140:9100
      1 172.31.4.6 172.31.6.158:443
      1 172.31.4.6 172.31.6.158:9100
      1 172.31.4.6 172.31.6.168:9100
      1 172.31.4.6 172.31.6.254:9100
      1 172.31.4.6 172.31.6.25:9100
      1 172.31.4.6 172.31.6.52:9100
      1 172.31.4.6 172.31.6.53:9100
      1 172.31.4.6 172.31.6.71:9100
      1 172.31.4.6 172.31.6.77:9100
      1 172.31.4.6 172.31.7.106:9100
      1 172.31.4.6 172.31.7.107:9100
      1 172.31.4.6 172.31.7.12:9100
      1 172.31.4.6 172.31.7.147:9100
      1 172.31.4.6 172.31.7.164:9100
      1 172.31.4.6 172.31.7.174:9100
      1 172.31.4.6 172.31.7.204:9100
      1 172.31.4.6 172.31.7.212:9100
      1 172.31.4.6 172.31.7.235:9100
      1 172.31.4.6 172.31.7.236:9100
      1 172.31.4.6 172.31.7.239:9100
      1 172.31.4.6 172.31.7.239:9101
      1 172.31.4.6 172.31.7.239:9102
      1 172.31.4.6 172.31.7.27:9100
      1 172.31.4.6 172.31.7.2:9100
      1 172.31.4.6 172.31.7.62:9100
      1 172.31.4.6 172.31.8.110:9100
      1 172.31.4.6 172.31.8.127:9100
      1 172.31.4.6 172.31.8.147:9100
      1 172.31.4.6 172.31.8.173:9100
      1 172.31.4.6 172.31.8.176:23333
      1 172.31.4.6 172.31.8.176:9100
      1 172.31.4.6 172.31.8.17:23334
      1 172.31.4.6 172.31.8.17:9100
      1 172.31.4.6 172.31.8.193:9100
      1 172.31.4.6 172.31.8.194:9100
      1 172.31.4.6 172.31.8.19:9100
      1 172.31.4.6 172.31.8.200:9100
      1 172.31.4.6 172.31.8.225:9100
      1 172.31.4.6 172.31.8.226:9100
      1 172.31.4.6 172.31.8.242:9100
      1 172.31.4.6 172.31.8.30:9100
      1 172.31.4.6 172.31.8.57:9100
      1 172.31.4.6 172.31.8.60:9100
      1 172.31.4.6 172.31.9.10:9100
      1 172.31.4.6 172.31.9.117:9100
      1 172.31.4.6 172.31.9.120:9100
      1 172.31.4.6 172.31.9.144:23333
      1 172.31.4.6 172.31.9.144:9100
      1 172.31.4.6 172.31.9.169:23334
      1 172.31.4.6 172.31.9.169:9100
      1 172.31.4.6 172.31.9.180:9100
      1 172.31.4.6 172.31.9.190:9100
      1 172.31.4.6 172.31.9.191:9100
      1 172.31.4.6 172.31.9.203:9100
      1 172.31.4.6 172.31.9.206:9100
      1 172.31.4.6 172.31.9.206:9200
      1 172.31.4.6 172.31.9.216:9100
      1 172.31.4.6 172.31.9.230:23333
      1 172.31.4.6 172.31.9.230:9100
      1 172.31.4.6 172.31.9.242:9100
      1 172.31.4.6 172.31.9.46:9100
      1 172.31.4.6 172.31.9.56:9100
      1 172.31.4.6 172.31.9.5:9100
      1 172.31.4.6 172.31.9.63:9100
      1 172.31.4.6 172.31.9.73:23333
      1 172.31.4.6 172.31.9.73:9100
      1 172.31.4.6 172.31.9.75:9100
      1 172.31.4.6 172.31.9.80:9100
      1 172.31.4.6 172.31.9.90:9100
      1 172.31.4.6 172.31.9.90:9200
      1 172.31.4.6 172.31.9.97:9100
      1 172.31.4.6 172.31.9.98:9100
      1 172.31.4.6 172.31.9.9:9100
      2 172.31.4.6 54.222.134.70:22
      1 172.31.4.6 54.222.17.62:443
      1 172.31.4.6 54.222.5.106:443
      2 172.31.4.6 54.222.6.211:443
      1 Peer Address:Port
root@prometheus-prod:~#
```

- 查看 prometheus 日志（对应 syslog 中的内容）

```
root@prometheus-prod:~# journalctl -u prometheus.service -f
-- Logs begin at Thu 2018-02-08 03:36:31 UTC. --
Feb 08 06:10:23 prometheus-prod prometheus[22347]: level=warn ts=2018-02-08T06:10:23.063273768Z caller=scrape.go:673 component="target manager" scrape_pool=static-targets target=http://172.31.14.149:23334/metrics msg="append failed" err="WAL log samples: log series: write /mnt/prometheus/wal/008905: file already closed"
Feb 08 06:10:23 prometheus-prod prometheus[22347]: level=warn ts=2018-02-08T06:10:23.078168953Z caller=scrape.go:673 component="target manager" scrape_pool=prometheus target=http://prom.llsops.com:80/metrics msg="append failed" err="WAL log samples: log series: write /mnt/prometheus/wal/008905: file already closed"
Feb 08 06:10:23 prometheus-prod prometheus[22347]: level=warn ts=2018-02-08T06:10:23.081456565Z caller=scrape.go:673 component="target manager" scrape_pool=nodes target=http://172.31.15.250:9100/metrics msg="append failed" err="WAL log samples: log series: write /mnt/prometheus/wal/008905: file already closed"
Feb 08 06:10:23 prometheus-prod prometheus[22347]: level=warn ts=2018-02-08T06:10:23.145970071Z caller=scrape.go:673 component="target manager" scrape_pool=nodes target=http://172.31.4.7:9100/metrics msg="append failed" err="WAL log samples: log series: write /mnt/prometheus/wal/008905: file already closed"
Feb 08 06:10:23 prometheus-prod prometheus[22347]: level=warn ts=2018-02-08T06:10:23.196794763Z caller=scrape.go:673 component="target manager" scrape_pool=nodes target=http://172.31.8.226:9100/metrics msg="append failed" err="WAL log samples: log series: write /mnt/prometheus/wal/008905: file already closed"
Feb 08 06:10:23 prometheus-prod prometheus[22347]: level=warn ts=2018-02-08T06:10:23.207296199Z caller=scrape.go:673 component="target manager" scrape_pool=nodes target=http://172.1.53.183:9100/metrics msg="append failed" err="WAL log samples: log series: write /mnt/prometheus/wal/008905: file already closed"
Feb 08 06:10:23 prometheus-prod prometheus[22347]: level=warn ts=2018-02-08T06:10:23.207489921Z caller=scrape.go:677 component="target manager" scrape_pool=nodes target=http://172.1.53.183:9100/metrics msg="append failed" err="WAL log samples: log series: write /mnt/prometheus/wal/008905: file already closed"
Feb 08 06:10:23 prometheus-prod prometheus[22347]: level=warn ts=2018-02-08T06:10:23.294418143Z caller=scrape.go:673 component="target manager" scrape_pool=nodes target=http://172.31.5.11:9100/metrics msg="append failed" err="WAL log samples: log series: write /mnt/prometheus/wal/008905: file already closed"
Feb 08 06:10:23 prometheus-prod prometheus[22347]: level=warn ts=2018-02-08T06:10:23.304922089Z caller=scrape.go:673 component="target manager" scrape_pool=static-targets target=http://172.31.10.212:23333/metrics msg="append failed" err="WAL log samples: log series: write /mnt/prometheus/wal/008905: file already closed"
Feb 08 06:10:23 prometheus-prod prometheus[22347]: level=warn ts=2018-02-08T06:10:23.327920881Z caller=scrape.go:673 component="target manager" scrape_pool=nodes target=http://172.31.14.1:9100/metrics msg="append failed" err="WAL log samples: log series: write /mnt/prometheus/wal/008905: file already closed"
Feb 08 06:10:23 prometheus-prod prometheus[22347]: level=warn ts=2018-02-08T06:10:23.343442749Z caller=manager.go:371 component="rule manager" group=grpc/error msg="rule sample appending failed" err="WAL log samples: log series: write /mnt/prometheus/wal/008905: file already closed"
Feb 08 06:10:23 prometheus-prod prometheus[22347]: level=warn ts=2018-02-08T06:10:23.344370961Z caller=manager.go:371 component="rule manager" group=grpc/error msg="rule sample appending failed" err="WAL log samples: log series: write /mnt/prometheus/wal/008905: file already closed"
Feb 08 06:10:23 prometheus-prod prometheus[22347]: level=warn ts=2018-02-08T06:10:23.344826852Z caller=manager.go:371 component="rule manager" group=grpc/error msg="rule sample appending failed" err="WAL log samples: log series: write /mnt/prometheus/wal/008905: file already closed"
Feb 08 06:10:23 prometheus-prod prometheus[22347]: level=warn ts=2018-02-08T06:10:23.371850432Z caller=scrape.go:673 component="target manager" scrape_pool=nodes target=http://172.31.9.203:9100/metrics msg="append failed" err="WAL log samples: log series: write /mnt/prometheus/wal/008905: file already closed"
Feb 08 06:10:23 prometheus-prod prometheus[22347]: level=warn ts=2018-02-08T06:10:23.38330218Z caller=scrape.go:673 component="target manager" scrape_pool=nodes target=http://172.31.12.249:9100/metrics msg="append failed" err="WAL log samples: log series: write /mnt/prometheus/wal/008905: file already closed"
...
Feb 08 06:10:25 prometheus-prod prometheus[22347]: level=warn ts=2018-02-08T06:10:25.420095193Z caller=scrape.go:673 component="target manager" scrape_pool=nodes target=http://172.31.4.56:9100/metrics msg="append failed" err="WAL log samples: log series: write /mnt/prometheus/wal/008905: file already closed"
^C
root@prometheus-prod:~#
```

- 查看 fd 的使用情况

> lsof 的输出不太容易区分 socket 和 file 

```
root@prometheus-prod:~# lsof -p 22347
COMMAND     PID USER   FD      TYPE             DEVICE  SIZE/OFF      NODE NAME
prometheu 22347 root  cwd       DIR              202,1      4096         2 /
prometheu 22347 root  rtd       DIR              202,1      4096         2 /
prometheu 22347 root  txt       REG              202,1  64627321    527100 /opt/apps/prometheus/prometheus
prometheu 22347 root  mem       REG             202,80 536866986  38010889 /mnt/prometheus/01C5R5MZVFFKSKGR7JRKEZXXPZ/chunks/000006
prometheu 22347 root  mem       REG             202,80 536868724  38010888 /mnt/prometheus/01C5R5MZVFFKSKGR7JRKEZXXPZ/chunks/000005
prometheu 22347 root  mem       REG             202,80 536864355  38010887 /mnt/prometheus/01C5R5MZVFFKSKGR7JRKEZXXPZ/chunks/000004
prometheu 22347 root  mem       REG             202,80 536865975  38010886 /mnt/prometheus/01C5R5MZVFFKSKGR7JRKEZXXPZ/chunks/000003
prometheu 22347 root  mem       REG             202,80 536868362  38010885 /mnt/prometheus/01C5R5MZVFFKSKGR7JRKEZXXPZ/chunks/000002
prometheu 22347 root  mem       REG             202,80 536868219  49938441 /mnt/prometheus/01C5PRQXNH877Q4WVN5004DQRH/chunks/000006
prometheu 22347 root  mem       REG             202,80 536870342  49938440 /mnt/prometheus/01C5PRQXNH877Q4WVN5004DQRH/chunks/000005
prometheu 22347 root  mem       REG             202,80 536864387  49938439 /mnt/prometheus/01C5PRQXNH877Q4WVN5004DQRH/chunks/000004
prometheu 22347 root  mem       REG             202,80 536854456  49938438 /mnt/prometheus/01C5PRQXNH877Q4WVN5004DQRH/chunks/000003
prometheu 22347 root  mem       REG             202,80 536867846  49938436 /mnt/prometheus/01C5PRQXNH877Q4WVN5004DQRH/chunks/000001
prometheu 22347 root  DEL       REG             202,80            18874372 /mnt/prometheus/01C5P0YNNDTGNFYZ7VFMDBCG5C/chunks/000001
prometheu 22347 root  mem       REG             202,80 536869230  24903684 /mnt/prometheus/01C5RTY2SP60R7BBDAVQHQ4EX9/chunks/000001
prometheu 22347 root  DEL       REG             202,80            26083331 /mnt/prometheus/01C5NT2YE9HNG0V052KNVBNJD3/index
prometheu 22347 root  DEL       REG             202,80            26083332 /mnt/prometheus/01C5NT2YE9HNG0V052KNVBNJD3/chunks/000001
prometheu 22347 root  DEL       REG             202,80             6422532 /mnt/prometheus/01C5P7TCXCD3RH1XGWTPHTN7V1/chunks/000001
prometheu 22347 root  DEL       REG             202,80            18874371 /mnt/prometheus/01C5P0YNNDTGNFYZ7VFMDBCG5C/index
prometheu 22347 root  mem       REG             202,80 249787691  38010883 /mnt/prometheus/01C5R5MZVFFKSKGR7JRKEZXXPZ/index
prometheu 22347 root  DEL       REG             202,80             6422531 /mnt/prometheus/01C5P7TCXCD3RH1XGWTPHTN7V1/index
prometheu 22347 root  mem       REG             202,80 565980784  12713987 /mnt/prometheus/01C5MA3JVV1DRZ4ZW2C8CK3H8Q/index
prometheu 22347 root  mem       REG             202,80 536828089  12714005 /mnt/prometheus/01C5MA3JVV1DRZ4ZW2C8CK3H8Q/chunks/000018
prometheu 22347 root  mem       REG             202,80 536861848  12714004 /mnt/prometheus/01C5MA3JVV1DRZ4ZW2C8CK3H8Q/chunks/000017
prometheu 22347 root  mem       REG             202,80 536841396  12714003 /mnt/prometheus/01C5MA3JVV1DRZ4ZW2C8CK3H8Q/chunks/000016
prometheu 22347 root  mem       REG             202,80 536864543  12714002 /mnt/prometheus/01C5MA3JVV1DRZ4ZW2C8CK3H8Q/chunks/000015
...
prometheu 22347 root 1009u     IPv6         2043846958       0t0       TCP ip-172-31-4-6.cn-north-1.compute.internal:9090->ip-172-31-4-6.cn-north-1.compute.internal:38908 (ESTABLISHED)
prometheu 22347 root 1010u     IPv4         2043846185       0t0       TCP ip-172-31-4-6.cn-north-1.compute.internal:39694->ip-172-31-4-131.cn-north-1.compute.internal:9100 (SYN_SENT)
prometheu 22347 root 1013r      REG             202,80 431018685  38010890 /mnt/prometheus/01C5R5MZVFFKSKGR7JRKEZXXPZ/chunks/000007
prometheu 22347 root 1014r      REG             202,80 249787691  38010883 /mnt/prometheus/01C5R5MZVFFKSKGR7JRKEZXXPZ/index
root@prometheus-prod:~#
```

- 查看 socket 和 file 两种类型 fd 的占比

```
root@prometheus-prod:~# ll /proc/15902/fd | grep "socket" | wc -l ; ll /proc/15902/fd | grep -v "socket" | wc -l ; ll /proc/15902/fd | wc -l
571
448
1019
root@prometheus-prod:~#
```

- 查看系统 ulimit 设置

```
root@prometheus-prod:~# ulimit -a
core file size          (blocks, -c) 0
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
file size               (blocks, -f) unlimited
pending signals                 (-i) 128641
max locked memory       (kbytes, -l) 64
max memory size         (kbytes, -m) unlimited
open files                      (-n) 1024
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
real-time priority              (-r) 0
stack size              (kbytes, -s) 8192
cpu time               (seconds, -t) unlimited
max user processes              (-u) 128641
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited
root@prometheus-prod:~#
```

- 查看进程 ulimit 设置

```
root@prometheus-prod:/proc/22347# cat limits
Limit                     Soft Limit           Hard Limit           Units
Max cpu time              unlimited            unlimited            seconds
Max file size             unlimited            unlimited            bytes
Max data size             unlimited            unlimited            bytes
Max stack size            8388608              unlimited            bytes
Max core file size        0                    unlimited            bytes
Max resident set          unlimited            unlimited            bytes
Max processes             128641               128641               processes
Max open files            1024                 4096                 files
Max locked memory         65536                65536                bytes
Max address space         unlimited            unlimited            bytes
Max file locks            unlimited            unlimited            locks
Max pending signals       128641               128641               signals
Max msgqueue size         819200               819200               bytes
Max nice priority         0                    0
Max realtime priority     0                    0
Max realtime timeout      unlimited            unlimited            us
root@prometheus-prod:/proc/22347#
```

- 调整 systemd 中 fd 限制

```
root@prometheus-prod:~# cat /etc/systemd/system/prometheus.service
[Unit]
Description=prometheus
After=network.target

[Service]
Type=simple
ExecStart=/opt/apps/prometheus/prometheus \
            --storage.tsdb.path=/mnt/prometheus  \
            --config.file=/opt/conf/prometheus/production/prometheus.yml \
            --storage.tsdb.retention="60d" \
            --web.external-url=http://prom.llsops.com \
            --web.max-connections=2048
ExecStop=/bin/kill -s SIGTERM $MAINPID
ExecReload=/bin/kill -s SIGHUP $MAINPID
Restart=always
RestartSec=2s
TimeoutStopSec=3min
StartLimitInterval=0
KillMode=process
LimitNOFILE=4096     -- 增加
[Install]
WantedBy=multi-user.target
root@prometheus-prod:~#
```

- 重启后，查看进程 ulimit 限制值

```
root@prometheus-prod:~# cat /proc/15902/limits
Limit                     Soft Limit           Hard Limit           Units
Max cpu time              unlimited            unlimited            seconds
Max file size             unlimited            unlimited            bytes
Max data size             unlimited            unlimited            bytes
Max stack size            8388608              unlimited            bytes
Max core file size        0                    unlimited            bytes
Max resident set          unlimited            unlimited            bytes
Max processes             128641               128641               processes
Max open files            4096                 4096                 files
Max locked memory         65536                65536                bytes
Max address space         unlimited            unlimited            bytes
Max file locks            unlimited            unlimited            locks
Max pending signals       128641               128641               signals
Max msgqueue size         819200               819200               bytes
Max nice priority         0                    0
Max realtime priority     0                    0
Max realtime timeout      unlimited            unlimited            us
root@prometheus-prod:~#
```


## 总结

- 增加 fd 后，之前的问题消失，可以确定问题确实和 fd 使用超限有关；
- 仍需要确认：
    - socket 使用量是否合理（是否真的存在那么多 node_exporter 需要交互，交互方式如何）
    - fd 使用量是否合理（是否和 retention policy 设置为 60d 有关）