# 流利说线上问题排查报告

## 问题描述

- 主要关注核心业务 neo 的表现；
- 线上经常出现访问延迟变大的问题；
- 线上 k8s 会动态扩容；
- 据说参照历史数据，业务访问量并没有明显变多；
- 怀疑运行多种业务的 pod 被调度到同一个 node 上时，会产生相互影响（throtted 值变高）；
- 据说运行不同业务的 pod 被调度到同一个 node 的顺序不同，产生的影响也会不同；

## 排查过程

确定当前 tcp 连接状态的分布情况；多次运行后确定基本稳定在如下分布；


```
root@ip-172-1-52-100:~# netstat -n | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}'
SYN_RECV 12
CLOSE_WAIT 577
TIME_WAIT 10
ESTABLISHED 16
root@ip-172-1-52-100:~#
```

当前结论：

- SYN_RECV 状态不应该长时间存在；
- CLOSE_WAIT 状态不应该长时间存在，且数量已经很多；
- TIME_WAIT 和 ESTABLISHED 都不多，说明访问量不大；


------


确定系统中全部监听端口的状态

```
root@ip-172-1-52-100:~# ss -nltp | awk '{ print $0 }'
State      Recv-Q Send-Q        Local Address:Port          Peer Address:Port
LISTEN     0      128               127.0.0.1:10248                    *:*      users:(("kubelet",pid=961,fd=10))
LISTEN     0      128               127.0.0.1:10249                    *:*      users:(("kube-proxy",pid=1515,fd=6))
LISTEN     0      128                       *:111                      *:*      users:(("rpcbind",pid=10947,fd=8))
LISTEN     0      128                       *:22                       *:*      users:(("sshd",pid=638,fd=3))
LISTEN     0      128                       *:35737                    *:*      users:(("rpc.statd",pid=500,fd=9))
LISTEN     0      128                      :::31806                   :::*      users:(("kube-proxy",pid=1515,fd=72))
LISTEN     0      128                      :::44446                   :::*      users:(("rpc.statd",pid=500,fd=11))
LISTEN     0      128                      :::32543                   :::*      users:(("kube-proxy",pid=1515,fd=73))
LISTEN     0      128                      :::32703                   :::*      users:(("kube-proxy",pid=1515,fd=14))
LISTEN     0      128                      :::30720                   :::*      users:(("kube-proxy",pid=1515,fd=35))
LISTEN     0      128                      :::31425                   :::*      users:(("kube-proxy",pid=1515,fd=16))
LISTEN     0      128                      :::30914                   :::*      users:(("kube-proxy",pid=1515,fd=56))
LISTEN     0      128                      :::4194                    :::*      users:(("kubelet",pid=961,fd=6))
LISTEN     0      128                      :::30563                   :::*      users:(("kube-proxy",pid=1515,fd=36))
LISTEN     11     128                      :::31460                   :::*      users:(("kube-proxy",pid=1515,fd=49))
LISTEN     2      128                      :::32420                   :::*      users:(("kube-proxy",pid=1515,fd=34))
LISTEN     0      128                      :::32068                   :::*      users:(("kube-proxy",pid=1515,fd=20))
LISTEN     0      128                      :::31813                   :::*      users:(("kube-proxy",pid=1515,fd=63))
LISTEN     129    128                      :::31493                   :::*      users:(("kube-proxy",pid=1515,fd=51))
LISTEN     72     128                      :::31591                   :::*      users:(("kube-proxy",pid=1515,fd=18))
LISTEN     0      128                      :::30184                   :::*      users:(("kube-proxy",pid=1515,fd=58))
LISTEN     0      128                      :::31753                   :::*      users:(("kube-proxy",pid=1515,fd=10))
LISTEN     0      128                      :::30217                   :::*      users:(("kube-proxy",pid=1515,fd=22))
LISTEN     0      128                      :::32426                   :::*      users:(("kube-proxy",pid=1515,fd=68))
LISTEN     0      128                      :::32746                   :::*      users:(("kube-proxy",pid=1515,fd=50))
LISTEN     0      128                      :::32522                   :::*      users:(("kube-proxy",pid=1515,fd=11))
LISTEN     0      128                      :::10250                   :::*      users:(("kubelet",pid=961,fd=12))
LISTEN     0      128                      :::30891                   :::*      users:(("kube-proxy",pid=1515,fd=61))
LISTEN     0      128                      :::31691                   :::*      users:(("kube-proxy",pid=1515,fd=15))
LISTEN     0      128                      :::31020                   :::*      users:(("kube-proxy",pid=1515,fd=59))
LISTEN     0      128                      :::9100                    :::*      users:(("node_exporter",pid=518,fd=3))
LISTEN     6      128                      :::30605                   :::*      users:(("kube-proxy",pid=1515,fd=60))
LISTEN     0      128                      :::30701                   :::*      users:(("kube-proxy",pid=1515,fd=54))
LISTEN     2      128                      :::30381                   :::*      users:(("kube-proxy",pid=1515,fd=23))
LISTEN     0      128                      :::30702                   :::*      users:(("kube-proxy",pid=1515,fd=48))
LISTEN     0      128                      :::32206                   :::*      users:(("kube-proxy",pid=1515,fd=62))
LISTEN     129    128                      :::32430                   :::*      users:(("kube-proxy",pid=1515,fd=53))
LISTEN     1      128                      :::32078                   :::*      users:(("kube-proxy",pid=1515,fd=47))
LISTEN     0      128                      :::111                     :::*      users:(("rpcbind",pid=10947,fd=11))
LISTEN     0      128                      :::31407                   :::*      users:(("kube-proxy",pid=1515,fd=39))
LISTEN     0      128                      :::10255                   :::*      users:(("kubelet",pid=961,fd=11))
LISTEN     0      128                      :::30672                   :::*      users:(("kube-proxy",pid=1515,fd=41))
LISTEN     0      128                      :::32752                   :::*      users:(("kube-proxy",pid=1515,fd=38))
LISTEN     0      128                      :::32720                   :::*      users:(("kube-proxy",pid=1515,fd=13))
LISTEN     0      128                      :::31889                   :::*      users:(("kube-proxy",pid=1515,fd=57))
LISTEN     0      128                      :::30225                   :::*      users:(("kube-proxy",pid=1515,fd=31))
LISTEN     0      128                      :::31122                   :::*      users:(("kube-proxy",pid=1515,fd=71))
LISTEN     0      128                      :::31698                   :::*      users:(("kube-proxy",pid=1515,fd=40))
LISTEN     0      128                      :::30931                   :::*      users:(("kube-proxy",pid=1515,fd=70))
LISTEN     0      128                      :::31123                   :::*      users:(("kube-proxy",pid=1515,fd=66))
LISTEN     129    128                      :::30899                   :::*      users:(("kube-proxy",pid=1515,fd=37))
LISTEN     0      128                      :::30579                   :::*      users:(("kube-proxy",pid=1515,fd=26))
LISTEN     0      128                      :::31380                   :::*      users:(("kube-proxy",pid=1515,fd=69))
LISTEN     0      128                      :::30196                   :::*      users:(("kube-proxy",pid=1515,fd=19))
LISTEN     68     128                      :::30613                   :::*      users:(("kube-proxy",pid=1515,fd=33))
LISTEN     63     128                      :::30966                   :::*      users:(("kube-proxy",pid=1515,fd=30))
LISTEN     0      128                      :::31926                   :::*      users:(("kube-proxy",pid=1515,fd=21))
LISTEN     0      128                      :::22                      :::*      users:(("sshd",pid=638,fd=4))
LISTEN     0      128                      :::30071                   :::*      users:(("kube-proxy",pid=1515,fd=29))
LISTEN     2      128                      :::31095                   :::*      users:(("kube-proxy",pid=1515,fd=64))
LISTEN     0      128                      :::30328                   :::*      users:(("kube-proxy",pid=1515,fd=46))
LISTEN     0      128                      :::31225                   :::*      users:(("kube-proxy",pid=1515,fd=74))
LISTEN     0      128                      :::31641                   :::*      users:(("kube-proxy",pid=1515,fd=67))
LISTEN     0      128                      :::31769                   :::*      users:(("kube-proxy",pid=1515,fd=45))
LISTEN     0      128                      :::30554                   :::*      users:(("kube-proxy",pid=1515,fd=12))
LISTEN     0      128                      :::32634                   :::*      users:(("kube-proxy",pid=1515,fd=52))
LISTEN     0      128                      :::32348                   :::*      users:(("kube-proxy",pid=1515,fd=44))
LISTEN     4      128                      :::30140                   :::*      users:(("kube-proxy",pid=1515,fd=32))
LISTEN     0      128                      :::32381                   :::*      users:(("kube-proxy",pid=1515,fd=27))
root@ip-172-1-52-100:~#
```


将搜索范围限制到 Recv-Q > 0 条件下

```
root@ip-172-1-52-100:~# ss -nltp| awk '{ if ($2 > 0) print $0 }'
State      Recv-Q Send-Q        Local Address:Port          Peer Address:Port
LISTEN     11     128                      :::31460                   :::*      users:(("kube-proxy",pid=1515,fd=49))
LISTEN     2      128                      :::32420                   :::*      users:(("kube-proxy",pid=1515,fd=34))
LISTEN     129    128                      :::31493                   :::*      users:(("kube-proxy",pid=1515,fd=51))
LISTEN     72     128                      :::31591                   :::*      users:(("kube-proxy",pid=1515,fd=18))
LISTEN     6      128                      :::30605                   :::*      users:(("kube-proxy",pid=1515,fd=60))
LISTEN     2      128                      :::30381                   :::*      users:(("kube-proxy",pid=1515,fd=23))
LISTEN     129    128                      :::32430                   :::*      users:(("kube-proxy",pid=1515,fd=53))
LISTEN     1      128                      :::32078                   :::*      users:(("kube-proxy",pid=1515,fd=47))
LISTEN     129    128                      :::30899                   :::*      users:(("kube-proxy",pid=1515,fd=37))
LISTEN     68     128                      :::30613                   :::*      users:(("kube-proxy",pid=1515,fd=33))
LISTEN     63     128                      :::30966                   :::*      users:(("kube-proxy",pid=1515,fd=30))
LISTEN     2      128                      :::31095                   :::*      users:(("kube-proxy",pid=1515,fd=64))
LISTEN     4      128                      :::30140                   :::*      users:(("kube-proxy",pid=1515,fd=32))
root@ip-172-1-52-100:~#
```


可以看到：

- 所有异常连接均来自 kube-proxy 进程；
- kube-proxy 上的连接异常分为两种：
    - 监听端口 **31493**、**32430** 和 **30899** 的 accept queue 已被占满；
    - 其它监听端口的 accept queue 虽然没被占满，但均有不同程度的“占用”，并且 Recv-Q 上的数值会保持稳定，非瞬态；


------


分别查看 31493、32430 和 30899 监听端口上的连接状态信息


确认 31493 端口上存在 SYN-RECV 和 CLOSE-WAIT 两种异常状态，并且可以发现 SYN-RECV 状态的连接会保持一定时间后消失，之后再有 SYN-RECV 状态的新连接出现；SYN-RECV 状态 12 个，有小波动；CLOSE-WAIT 状态有 4 个，稳定；

```
root@ip-172-1-52-100:~# ss -antp| grep "31493"
LISTEN     129    128                      :::31493                   :::*      users:(("kube-proxy",pid=1515,fd=51))
SYN-RECV   0      0       ::ffff:172.1.52.100:31493  ::ffff:172.1.42.207:35249
SYN-RECV   0      0       ::ffff:172.1.52.100:31493  ::ffff:172.1.61.192:49837
SYN-RECV   0      0       ::ffff:172.1.52.100:31493  ::ffff:172.1.61.192:50285
SYN-RECV   0      0       ::ffff:172.1.52.100:31493  ::ffff:172.1.42.207:35103
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31493  ::ffff:172.1.61.192:64923
SYN-RECV   0      0       ::ffff:172.1.52.100:31493  ::ffff:172.1.61.192:49535
SYN-RECV   0      0       ::ffff:172.1.52.100:31493  ::ffff:172.1.61.192:49985
SYN-RECV   0      0       ::ffff:172.1.52.100:31493  ::ffff:172.1.42.207:34803
SYN-RECV   0      0       ::ffff:172.1.52.100:31493  ::ffff:172.1.42.207:34949
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31493  ::ffff:172.1.42.207:50389
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31493  ::ffff:172.1.42.207:44665
SYN-RECV   0      0       ::ffff:172.1.52.100:31493  ::ffff:172.1.42.207:35403
SYN-RECV   0      0       ::ffff:172.1.52.100:31493  ::ffff:172.1.61.192:49681
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31493  ::ffff:172.1.42.207:48191
SYN-RECV   0      0       ::ffff:172.1.52.100:31493  ::ffff:172.1.42.207:35551
SYN-RECV   0      0       ::ffff:172.1.52.100:31493  ::ffff:172.1.61.192:50139
root@ip-172-1-52-100:~# 
```

> 此处，可以针对 172.1.42.207 继续查下去


确认 32430 端口上只存在 CLOSE-WAIT 异常状态，数量为 125 个

```
root@ip-172-1-52-100:~# ss -antp| grep "32430"
LISTEN     129    128                      :::32430                   :::*      users:(("kube-proxy",pid=1515,fd=53))
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:63659
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:58287
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:26254
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:58139
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:46758
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:64561
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:44630
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:25610
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:48544
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:25613
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:57833
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:42818
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:26866
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:58993
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:14975
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:25916
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:63805
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:17898
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:15121
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:63503
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:44034
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:58735
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:7685
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:42984
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:46139
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:15425
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:7593
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:18048
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:45706
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:17292
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:62561
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:58585
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:44186
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:57981
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:46130
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:45833
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:41873
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:46608
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:42023
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:43132
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:33129
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:20166
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:62897
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:18194
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:25768
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:17146
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:26550
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:63355
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:19862
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:58437
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:64103
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:45856
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:27016
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:16390
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:62409
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:17752
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:53477
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:43284
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:62713
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:16850
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:63049
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:16544
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:31932
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:19404
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:44334
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:25014
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:18950
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:43886
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:46585
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:41567
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:24866
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:25164
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:64257
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:20008
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:55333
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:27166
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:19096
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:18496
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:32078
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:46287
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:63195
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:45088
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:25312
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:15277
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:64409
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:19250
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:46450
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:45542
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:25763
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:18800
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:46006
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:45236
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:41713
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:45981
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:16996
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:16616
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:17598
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:46154
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:25464
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:46908
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:45396
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:19556
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:48394
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:46737
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:44788
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:64709
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:25913
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:17446
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:26404
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:26718
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:19712
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:46304
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:18654
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:57683
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:43432
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:26104
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:63957
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:44938
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:7539
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:48700
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:14758
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:20316
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:16692
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.58.151:18348
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:32430  ::ffff:172.1.48.252:43582
root@ip-172-1-52-100:~#
```



确认 30899 端口上只存在 CLOSE-WAIT 异常状态，数量为 129 个

```
root@ip-172-1-52-100:~# ss -antp| grep "30899"
LISTEN     129    128                      :::30899                   :::*      users:(("kube-proxy",pid=1515,fd=37))
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:63814
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:22575
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:60278
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:58516
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:24101
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:63232
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:63958
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:57638
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:1753
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:2967
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:2531
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:23925
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:22425
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:14571
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:15741
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:59246
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:63520
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:23623
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:20515
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:15449
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:15303
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:23027
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:17075
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:19783
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:17517
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:2675
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:15895
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:1307
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:62492
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:14425
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:20367
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:2079
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:3113
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:64398
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:2825
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:62638
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:21981
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:16337
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:16479
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:58954
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:59838
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:22127
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:60572
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:17223
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:22279
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:16933
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:21099
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:58076
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:57932
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:16781
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:57490
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:23461
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:57198
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:58664
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:14863
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:60426
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:61750
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:22873
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:14129
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:64996
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:64252
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:20803
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:64110
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:15591
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:16047
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:64844
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:61898
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:59694
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:21839
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:57348
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:59988
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:20661
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:59104
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:57786
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:2225
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:1461
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:62932
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:20079
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:59544
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:64546
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:2383
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:15161
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:58368
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:24395
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:63664
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:64692
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:20957
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:23771
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:19925
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:14283
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:21397
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:17661
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:24843
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:1937
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:22731
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:23317
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:62044
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:61604
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:14713
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:58810
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:63374
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:60132
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:62188
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:24249
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:19199
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:62340
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:15009
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:23171
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:1161
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:63080
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:59400
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:16629
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:60716
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:20221
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:62786
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:19631
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:24553
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:21249
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:16189
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:24697
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:58226
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:24987
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:17365
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:19489
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:61460
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:21685
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899  ::ffff:172.1.60.128:1607
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:19341
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30899    ::ffff:172.1.59.2:21543
root@ip-172-1-52-100:~#
```


当前结论：

- 31493 端口 accept queue 满，但 SYN-RECV 状态 12 个，CLOSE-WAIT 状态有 4 个，说明还存在其他状态在其中；
- 32430 端口 accept queue 满，但只看到 CLOSE-WAIT 状态数量为 125 个，说明还有其他状态在其中；
- 30899 端口 accept queue 满，只存在 CLOSE-WAIT 异常状态，数量刚好为 129 个；


------


抓包分析 31493 端口

```
root@ip-172-1-52-100:~# tcpdump -i eth0 tcp port 31493 -s 0 -w 31493.pcap
tcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
^C151 packets captured
178 packets received by filter
0 packets dropped by kernel
root@ip-172-1-52-100:~#
```

![](https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/31493-64440%20_tcp_stream.png)

能够发现

- syn,ack 重传 5 次，时间间隔分布 1s, 2s, 4s, 8s
- 客户端侧（172.1.42.207）在建立 tcp 连接后，立即关闭连接（难道是健康检测？如果是的话，应该改）；
- fin,ack 重传 9 次，时间间隔分布 200ms, 200ms, 400ms, 800ms, 1600ms, 3200ms, 6400ms, 12800ms


确定系统参数配置

```
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 512
net.ipv4.tcp_abort_on_overflow = 0
net.core.somaxconn = 128
net.ipv4.tcp_synack_retries = 5
```


当前结论：

- Accept queue 已满，因此在收到三次握手最后的 ACK 时，在 `tcp_abort_on_overflow = 0` 设置下，TCP 协议栈会将该连接标记为 acked ，但仍保留在 SYN queue 中，并启动 timer 以便重发 SYN,ACK 包；当 SYN,ACK 的重传次数超过 `net.ipv4.tcp_synack_retries = 5` 设置值时，再将该连接从 SYN queue 中删除；
- SYN queue 未满（若 SYN queue 已满，在 `net.ipv4.tcp_syncookies = 1` 且 Accept queue 已满的情况下，会直接丢弃 SYN 包，不会回复 SYN,ACK 包）；
- FIN,ACK 被不断重传的原因，是因为服务器侧认为当前连接处于 SYN-RECV 状态，即并未成功建立连接，因此也就不会对 FIN 包做任何回应；

可疑点：

- **客户端连接建立后立即关闭连接的行为**；
- **kube-proxy 的 accept queue 满的原因**；
- **kube-proxy 侧 CLOSE-WAIT 成因**；



确认 kube-proxy 的进程关系

```
root@ip-172-1-52-100:~# ps ajxf|grep kube-proxy
 3841  2694  2693  3389 pts/0     2693 S+       0   0:00                      \_ grep kube-proxy
 1495  1510  1510  1510 ?           -1 Ss       0   0:00      |   \_ /bin/sh -c kube-proxy --kubeconfig=/var/lib/kube-proxy/kubeconfig --resource-container="" --master=https://api.prod0-cluster-cn-north1a.llsops.com --v=2 1>>/var/log/kube-proxy.log 2>&1
 1510  1515  1510  1510 ?           -1 Sl       0 758:14      |       \_ kube-proxy --kubeconfig=/var/lib/kube-proxy/kubeconfig --resource-container= --master=https://api.prod0-cluster-cn-north1a.llsops.com --v=2
root@ip-172-1-52-100:~#
```

确认 kube-proxy 的线程关系

```
root@ip-172-1-52-100:~# ps -eLf
UID        PID  PPID   LWP  C NLWP STIME TTY          TIME CMD
...
root      1510  1495  1510  0    1  2017 ?        00:00:00 /bin/sh -c kube-proxy --kubeconfig=/var/lib/kube-proxy/kubeconfig --resource-container="" --master=https://api.prod0-cluster-cn-north1a.llsops.com --v=2 1>>/var/log/kube-proxy.log 2>&1
root      1515  1510  1515  0   16  2017 ?        00:38:21 kube-proxy --kubeconfig=/var/lib/kube-proxy/kubeconfig --resource-container= --master=https://api.prod0-cluster-cn-north1a.llsops.com --v=2
root      1515  1510  1516  0   16  2017 ?        01:10:50 kube-proxy --kubeconfig=/var/lib/kube-proxy/kubeconfig --resource-container= --master=https://api.prod0-cluster-cn-north1a.llsops.com --v=2
root      1515  1510  1517  0   16  2017 ?        00:47:34 kube-proxy --kubeconfig=/var/lib/kube-proxy/kubeconfig --resource-container= --master=https://api.prod0-cluster-cn-north1a.llsops.com --v=2
root      1515  1510  1518  0   16  2017 ?        00:49:45 kube-proxy --kubeconfig=/var/lib/kube-proxy/kubeconfig --resource-container= --master=https://api.prod0-cluster-cn-north1a.llsops.com --v=2
root      1515  1510  1519  0   16  2017 ?        00:33:59 kube-proxy --kubeconfig=/var/lib/kube-proxy/kubeconfig --resource-container= --master=https://api.prod0-cluster-cn-north1a.llsops.com --v=2
root      1515  1510  1520  0   16  2017 ?        00:49:43 kube-proxy --kubeconfig=/var/lib/kube-proxy/kubeconfig --resource-container= --master=https://api.prod0-cluster-cn-north1a.llsops.com --v=2
root      1515  1510  1522  0   16  2017 ?        00:42:51 kube-proxy --kubeconfig=/var/lib/kube-proxy/kubeconfig --resource-container= --master=https://api.prod0-cluster-cn-north1a.llsops.com --v=2
root      1515  1510  1523  0   16  2017 ?        00:48:15 kube-proxy --kubeconfig=/var/lib/kube-proxy/kubeconfig --resource-container= --master=https://api.prod0-cluster-cn-north1a.llsops.com --v=2
root      1515  1510  1525  0   16  2017 ?        00:49:06 kube-proxy --kubeconfig=/var/lib/kube-proxy/kubeconfig --resource-container= --master=https://api.prod0-cluster-cn-north1a.llsops.com --v=2
root      1515  1510  1526  0   16  2017 ?        00:45:20 kube-proxy --kubeconfig=/var/lib/kube-proxy/kubeconfig --resource-container= --master=https://api.prod0-cluster-cn-north1a.llsops.com --v=2
root      1515  1510  1528  0   16  2017 ?        00:49:16 kube-proxy --kubeconfig=/var/lib/kube-proxy/kubeconfig --resource-container= --master=https://api.prod0-cluster-cn-north1a.llsops.com --v=2
root      1515  1510  1630  0   16  2017 ?        00:45:03 kube-proxy --kubeconfig=/var/lib/kube-proxy/kubeconfig --resource-container= --master=https://api.prod0-cluster-cn-north1a.llsops.com --v=2
root      1515  1510  1662  0   16  2017 ?        00:41:58 kube-proxy --kubeconfig=/var/lib/kube-proxy/kubeconfig --resource-container= --master=https://api.prod0-cluster-cn-north1a.llsops.com --v=2
root      1515  1510  1814  0   16  2017 ?        00:49:43 kube-proxy --kubeconfig=/var/lib/kube-proxy/kubeconfig --resource-container= --master=https://api.prod0-cluster-cn-north1a.llsops.com --v=2
root      1515  1510  3719  0   16  2017 ?        00:42:22 kube-proxy --kubeconfig=/var/lib/kube-proxy/kubeconfig --resource-container= --master=https://api.prod0-cluster-cn-north1a.llsops.com --v=2
root      1515  1510  1001  0   16  2017 ?        00:51:07 kube-proxy --kubeconfig=/var/lib/kube-proxy/kubeconfig --resource-container= --master=https://api.prod0-cluster-cn-north1a.llsops.com --v=2
```

某一个时间点，全部线程运行时调用栈信息

```
root@ip-172-1-52-100:~# for i in `ls /proc/1515/task/`; do cat /proc/1515/task/${i}/stack; echo "----"; done
[<ffffffff810eff3f>] futex_wait_queue_me+0xcf/0x130
[<ffffffff810f071f>] futex_wait+0xff/0x260
[<ffffffff810a20f3>] try_to_wake_up+0x43/0x380
[<ffffffff810f2390>] do_futex+0x110/0xb50
[<ffffffff8119a430>] handle_mm_fault+0xd70/0x1840
[<ffffffff810f2e53>] SyS_futex+0x83/0x180
[<ffffffff8100c2b1>] xen_clocksource_get_cycles+0x11/0x20
[<ffffffff810e517f>] ktime_get_ts64+0x3f/0xf0
[<ffffffff815a13b6>] entry_SYSCALL_64_fastpath+0x16/0x75
[<ffffffffffffffff>] 0xffffffffffffffff
----
[<ffffffff810eff3f>] futex_wait_queue_me+0xcf/0x130
[<ffffffff810f071f>] futex_wait+0xff/0x260
[<ffffffff810a20f3>] try_to_wake_up+0x43/0x380
[<ffffffff810f2390>] do_futex+0x110/0xb50
[<ffffffff810bda11>] __raw_callee_save___pv_queued_spin_unlock+0x11/0x20
[<ffffffff8119a430>] handle_mm_fault+0xd70/0x1840
[<ffffffff810ac77a>] update_curr+0xba/0x130
[<ffffffff810aa3bf>] pick_next_entity+0x7f/0x140
[<ffffffff8100c2b1>] xen_clocksource_get_cycles+0x11/0x20
[<ffffffff810e517f>] ktime_get_ts64+0x3f/0xf0
[<ffffffff811ef9bd>] poll_select_copy_remaining+0xfd/0x150
[<ffffffff810f2e53>] SyS_futex+0x83/0x180
[<ffffffff811f080c>] SyS_select+0xcc/0x110
[<ffffffff815a13b6>] entry_SYSCALL_64_fastpath+0x16/0x75
[<ffffffffffffffff>] 0xffffffffffffffff
----
[<ffffffff810eff3f>] futex_wait_queue_me+0xcf/0x130
[<ffffffff810f071f>] futex_wait+0xff/0x260
[<ffffffff810dffb0>] hrtimer_wakeup+0x0/0x30
[<ffffffff810eff1c>] futex_wait_queue_me+0xac/0x130
[<ffffffff810f2390>] do_futex+0x110/0xb50
[<ffffffff815a3538>] page_fault+0x28/0x30
[<ffffffff8119a430>] handle_mm_fault+0xd70/0x1840
[<ffffffff8100c2b1>] xen_clocksource_get_cycles+0x11/0x20
[<ffffffff810e517f>] ktime_get_ts64+0x3f/0xf0
[<ffffffff811ef9bd>] poll_select_copy_remaining+0xfd/0x150
[<ffffffff810f2e53>] SyS_futex+0x83/0x180
[<ffffffff815a13b6>] entry_SYSCALL_64_fastpath+0x16/0x75
[<ffffffffffffffff>] 0xffffffffffffffff
----
[<ffffffff810eff3f>] futex_wait_queue_me+0xcf/0x130
[<ffffffff810f071f>] futex_wait+0xff/0x260
[<ffffffff810dffb0>] hrtimer_wakeup+0x0/0x30
[<ffffffff810eff1c>] futex_wait_queue_me+0xac/0x130
[<ffffffff810f2390>] do_futex+0x110/0xb50
[<ffffffff81016763>] do_signal+0x1c3/0x6d0
[<ffffffff8119a430>] handle_mm_fault+0xd70/0x1840
[<ffffffff810f2e53>] SyS_futex+0x83/0x180
[<ffffffff815a13b6>] entry_SYSCALL_64_fastpath+0x16/0x75
[<ffffffffffffffff>] 0xffffffffffffffff
----
[<ffffffff810eff3f>] futex_wait_queue_me+0xcf/0x130
[<ffffffff810f071f>] futex_wait+0xff/0x260
[<ffffffff810a20f3>] try_to_wake_up+0x43/0x380
[<ffffffff810f2390>] do_futex+0x110/0xb50
[<ffffffff8119a430>] handle_mm_fault+0xd70/0x1840
[<ffffffff810ac77a>] update_curr+0xba/0x130
[<ffffffff810aa3bf>] pick_next_entity+0x7f/0x140
[<ffffffff8100c2b1>] xen_clocksource_get_cycles+0x11/0x20
[<ffffffff810e517f>] ktime_get_ts64+0x3f/0xf0
[<ffffffff811ef9bd>] poll_select_copy_remaining+0xfd/0x150
[<ffffffff810f2e53>] SyS_futex+0x83/0x180
[<ffffffff811f080c>] SyS_select+0xcc/0x110
[<ffffffff815a13b6>] entry_SYSCALL_64_fastpath+0x16/0x75
[<ffffffffffffffff>] 0xffffffffffffffff
----
[<ffffffff810f2390>] do_futex+0x110/0xb50
[<ffffffff81016763>] do_signal+0x1c3/0x6d0
[<ffffffff810bda11>] __raw_callee_save___pv_queued_spin_unlock+0x11/0x20
[<ffffffff812219d2>] ep_poll+0x342/0x3f0
[<ffffffff810a24b0>] default_wake_function+0x0/0x10
[<ffffffff81222df9>] SyS_epoll_wait+0xb9/0xd0
[<ffffffff815a13b6>] entry_SYSCALL_64_fastpath+0x16/0x75
[<ffffffffffffffff>] 0xffffffffffffffff
----
[<ffffffff810eff3f>] futex_wait_queue_me+0xcf/0x130
[<ffffffff810f071f>] futex_wait+0xff/0x260
[<ffffffff810a20f3>] try_to_wake_up+0x43/0x380
[<ffffffff810f2390>] do_futex+0x110/0xb50
[<ffffffff8119a430>] handle_mm_fault+0xd70/0x1840
[<ffffffff811dd3f1>] __fput+0x161/0x1d0
[<ffffffff810f2e53>] SyS_futex+0x83/0x180
[<ffffffff81063780>] __do_page_fault+0x1c0/0x440
[<ffffffff815a13b6>] entry_SYSCALL_64_fastpath+0x16/0x75
[<ffffffffffffffff>] 0xffffffffffffffff
----
[<ffffffff810eff3f>] futex_wait_queue_me+0xcf/0x130
[<ffffffff810f071f>] futex_wait+0xff/0x260
[<ffffffff810bda11>] __raw_callee_save___pv_queued_spin_unlock+0x11/0x20
[<ffffffff8109f9fd>] finish_task_switch+0x6d/0x230
[<ffffffff810f2390>] do_futex+0x110/0xb50
[<ffffffff810bda11>] __raw_callee_save___pv_queued_spin_unlock+0x11/0x20
[<ffffffff811e4285>] put_pipe_info+0x45/0x60
[<ffffffff811f29eb>] dput+0x2b/0x210
[<ffffffff811dd3f1>] __fput+0x161/0x1d0
[<ffffffff810f2e53>] SyS_futex+0x83/0x180
[<ffffffff81003200>] exit_to_usermode_loop+0xa0/0xc0
[<ffffffff815a13b6>] entry_SYSCALL_64_fastpath+0x16/0x75
[<ffffffffffffffff>] 0xffffffffffffffff
----
[<ffffffff810eff3f>] futex_wait_queue_me+0xcf/0x130
[<ffffffff810f071f>] futex_wait+0xff/0x260
[<ffffffff810a20f3>] try_to_wake_up+0x43/0x380
[<ffffffff810f2390>] do_futex+0x110/0xb50
[<ffffffff810abf11>] set_next_entity+0x71/0x7d0
[<ffffffff8119a430>] handle_mm_fault+0xd70/0x1840
[<ffffffff810ac715>] update_curr+0x55/0x130
[<ffffffff810bda11>] __raw_callee_save___pv_queued_spin_unlock+0x11/0x20
[<ffffffff810f2e53>] SyS_futex+0x83/0x180
[<ffffffff815a13b6>] entry_SYSCALL_64_fastpath+0x16/0x75
[<ffffffffffffffff>] 0xffffffffffffffff
----
[<ffffffff810eff3f>] futex_wait_queue_me+0xcf/0x130
[<ffffffff810f071f>] futex_wait+0xff/0x260
[<ffffffff810a20f3>] try_to_wake_up+0x43/0x380
[<ffffffff810f2390>] do_futex+0x110/0xb50
[<ffffffff8119a430>] handle_mm_fault+0xd70/0x1840
[<ffffffff810f2e53>] SyS_futex+0x83/0x180
[<ffffffff81063780>] __do_page_fault+0x1c0/0x440
[<ffffffff815a13b6>] entry_SYSCALL_64_fastpath+0x16/0x75
[<ffffffffffffffff>] 0xffffffffffffffff
----
[<ffffffff810eff3f>] futex_wait_queue_me+0xcf/0x130
[<ffffffff810f071f>] futex_wait+0xff/0x260
[<ffffffff810efc9c>] get_futex_key+0x1bc/0x290
[<ffffffff810f2390>] do_futex+0x110/0xb50
[<ffffffff8119a430>] handle_mm_fault+0xd70/0x1840
[<ffffffff810ac77a>] update_curr+0xba/0x130
[<ffffffff810aa3bf>] pick_next_entity+0x7f/0x140
[<ffffffff810b332f>] pick_next_task_fair+0x30f/0x4a0
[<ffffffff8100c291>] xen_clocksource_read+0x11/0x20
[<ffffffff810f2e53>] SyS_futex+0x83/0x180
[<ffffffff815a13b6>] entry_SYSCALL_64_fastpath+0x16/0x75
[<ffffffffffffffff>] 0xffffffffffffffff
----
[<ffffffff810eff3f>] futex_wait_queue_me+0xcf/0x130
[<ffffffff810f071f>] futex_wait+0xff/0x260
[<ffffffff810a20f3>] try_to_wake_up+0x43/0x380
[<ffffffff810f2390>] do_futex+0x110/0xb50
[<ffffffff810abf11>] set_next_entity+0x71/0x7d0
[<ffffffff8119a430>] handle_mm_fault+0xd70/0x1840
[<ffffffff810ac715>] update_curr+0x55/0x130
[<ffffffff810bda11>] __raw_callee_save___pv_queued_spin_unlock+0x11/0x20
[<ffffffff810f2e53>] SyS_futex+0x83/0x180
[<ffffffff815a13b6>] entry_SYSCALL_64_fastpath+0x16/0x75
[<ffffffffffffffff>] 0xffffffffffffffff
----
[<ffffffff810eff3f>] futex_wait_queue_me+0xcf/0x130
[<ffffffff810f071f>] futex_wait+0xff/0x260
[<ffffffff810a20f3>] try_to_wake_up+0x43/0x380
[<ffffffff810f2390>] do_futex+0x110/0xb50
[<ffffffff81199d46>] handle_mm_fault+0x686/0x1840
[<ffffffff8109f9fd>] finish_task_switch+0x6d/0x230
[<ffffffff810f2e53>] SyS_futex+0x83/0x180
[<ffffffff8100c2b1>] xen_clocksource_get_cycles+0x11/0x20
[<ffffffff810e517f>] ktime_get_ts64+0x3f/0xf0
[<ffffffff815a13b6>] entry_SYSCALL_64_fastpath+0x16/0x75
[<ffffffffffffffff>] 0xffffffffffffffff
----
[<ffffffff810eff3f>] futex_wait_queue_me+0xcf/0x130
[<ffffffff810f071f>] futex_wait+0xff/0x260
[<ffffffff810a20f3>] try_to_wake_up+0x43/0x380
[<ffffffff810f2390>] do_futex+0x110/0xb50
[<ffffffff810abf11>] set_next_entity+0x71/0x7d0
[<ffffffff810ac77a>] update_curr+0xba/0x130
[<ffffffff810aa3bf>] pick_next_entity+0x7f/0x140
[<ffffffff810b332f>] pick_next_task_fair+0x30f/0x4a0
[<ffffffff8100c291>] xen_clocksource_read+0x11/0x20
[<ffffffff810f2e53>] SyS_futex+0x83/0x180
[<ffffffff815a13b6>] entry_SYSCALL_64_fastpath+0x16/0x75
[<ffffffffffffffff>] 0xffffffffffffffff
----
[<ffffffff810eff3f>] futex_wait_queue_me+0xcf/0x130
[<ffffffff810f071f>] futex_wait+0xff/0x260
[<ffffffff810a20f3>] try_to_wake_up+0x43/0x380
[<ffffffff810f2390>] do_futex+0x110/0xb50
[<ffffffff8119a430>] handle_mm_fault+0xd70/0x1840
[<ffffffff8100c2b1>] xen_clocksource_get_cycles+0x11/0x20
[<ffffffff810e517f>] ktime_get_ts64+0x3f/0xf0
[<ffffffff811ef9bd>] poll_select_copy_remaining+0xfd/0x150
[<ffffffff810f2e53>] SyS_futex+0x83/0x180
[<ffffffff8100c2b1>] xen_clocksource_get_cycles+0x11/0x20
[<ffffffff810e517f>] ktime_get_ts64+0x3f/0xf0
[<ffffffff815a13b6>] entry_SYSCALL_64_fastpath+0x16/0x75
[<ffffffffffffffff>] 0xffffffffffffffff
----
[<ffffffff810eff3f>] futex_wait_queue_me+0xcf/0x130
[<ffffffff810f071f>] futex_wait+0xff/0x260
[<ffffffff810f2390>] do_futex+0x110/0xb50
[<ffffffff81016763>] do_signal+0x1c3/0x6d0
[<ffffffff8119a430>] handle_mm_fault+0xd70/0x1840
[<ffffffff810f2e53>] SyS_futex+0x83/0x180
[<ffffffff81063780>] __do_page_fault+0x1c0/0x440
[<ffffffff815a13b6>] entry_SYSCALL_64_fastpath+0x16/0x75
[<ffffffffffffffff>] 0xffffffffffffffff
----
root@ip-172-1-52-100:~#
```

系统调用分析，可以看出

- 一次 accept 都没有调用（后来发现，对于 kube-proxy 来说，连接的建立似乎真的不需要 accept ，这个点尚不清楚原因）；
- 79% 的时间花费在 futex 锁调用上；

```
root@ip-172-1-52-100:~# strace -p 1515 -f -c
Process 1515 attached with 16 threads
...

% time     seconds  usecs/call     calls    errors syscall
------ ----------- ----------- --------- --------- ----------------
 79.46   51.761311       11796      4388       147 futex
  8.60    5.604000       45934       122           epoll_wait
  8.48    5.527049       18362       301           wait4
  0.97    0.631002         126      5022         2 select
  0.96    0.628000      628000         1         1 restart_syscall
  0.95    0.620200        5002       124           setsockopt
  0.53    0.347032           9     38504        29 read
  0.02    0.012056           9      1411           write
  0.00    0.002076           0     54720     52933 stat
  0.00    0.001644           0     32535           munmap
  0.00    0.001548           0     36737      1456 open
  0.00    0.001294           0     35463           fstat
  0.00    0.001207           0     37608           close
  0.00    0.001164           0     40680           mmap
  0.00    0.001010           0     12891           clock_gettime
  0.00    0.000930           1      1089           getsockopt
  0.00    0.000589           0      1700           sched_yield
  0.00    0.000381           1       301           clone
  0.00    0.000183           0      6520           mprotect
  0.00    0.000036           0      1060           socket
  0.00    0.000031           0       757           fcntl
  0.00    0.000023           0       241           bind
  0.00    0.000020           0       633           pipe2
  0.00    0.000018           0       270           openat
  0.00    0.000017           0       301           rt_sigreturn
  0.00    0.000015           0       301           getpid
  0.00    0.000000           0        91           lstat
  0.00    0.000000           0        60           lseek
  0.00    0.000000           0      1898           brk
  0.00    0.000000           0      2590      2590 access
  0.00    0.000000           0       903           dup2
  0.00    0.000000           0       124        31 connect
  0.00    0.000000           0        31           sendto
  0.00    0.000000           0        93           recvmsg
  0.00    0.000000           0        93           getsockname
  0.00    0.000000           0       301           execve
  0.00    0.000000           0        91           statfs
  0.00    0.000000           0       301           arch_prctl
------ ----------- ----------- --------- --------- ----------------
100.00   65.142836                320256     57189 total
root@ip-172-1-52-100:~#
```




当前结论：

- 客户端连接建立后立即关闭连接的行为可能存在问题；
- kube-proxy 的 accept queue 满的原因严重怀疑和 CLOSE-WAIT 状态的连接有关联（需要研究确认）；
- kube-proxy 侧 CLOSE-WAIT 的原因，怀疑是自身 bug 问题（也可能是由于 k8s 调度和业务本身同时导致的问题）；
- 可以进行适当系统调优，但针对目前的问题来说，治标不治本（例如调大监听端口的 accept queue 长度）；


-------



## 辅助数据分析


观察 tcp 统计信息

```
root@ip-172-1-52-100:~# netstat -st
IcmpMsg:
    InType3: 102
    InType11: 1
    OutType3: 2379
    OutType5: 9115
Tcp:
    924259 active connections openings
    1006 passive connection openings
    100 failed connection attempts
    787 connection resets received
    16 connections established
    18434872 segments received
    15341092 segments send out
    2254328 segments retransmited
    51 bad segments received.
    109946 resets sent
    InCsumErrors: 4
UdpLite:
TcpExt:
    509 packets pruned from receive queue because of socket buffer overrun
    372836 TCP sockets finished time wait in fast timer
    1 packets rejects in established connections because of timestamp
    365536 delayed acks sent
    19 delayed acks further delayed because of locked socket
    Quick ack mode was activated 56 times
    7203095 times the listen queue of a socket overflowed
    7203095 SYNs to LISTEN sockets dropped
    4074731 packet headers predicted
    2329004 acknowledgments not containing data payload received
    699192 predicted acknowledgments
    1 times recovered from packet loss by selective acknowledgements
    398 congestion windows recovered without slow start after partial ack
    TCPLostRetransmit: 1
    1 retransmits in slow start
    2702307 other TCP timeouts
    TCPLossProbes: 182
    TCPLossProbeRecovery: 5
    203324 packets collapsed in receive queue due to low socket buffer
    57 DSACKs sent for old packets
    6 DSACKs sent for out of order packets
    78 DSACKs received
    96702 connections reset due to unexpected data
    234 connections reset due to early user close
    5 connections aborted due to timeout
    TCPDSACKIgnoredNoUndo: 58
    TCPSackShiftFallback: 3
    TCPBacklogDrop: 22
    TCPRcvCoalesce: 973867
    TCPOFOQueue: 77544
    TCPOFOMerge: 6
    TCPChallengeACK: 198
    TCPSYNChallenge: 197
    TCPSpuriousRtxHostQueues: 52
    TCPAutoCorking: 299805
    TCPWantZeroWindowAdv: 1551
    TCPSynRetrans: 2254002
    TCPOrigDataSent: 4483473
    TCPHystartTrainDetect: 8
    TCPHystartTrainCwnd: 147
    TCPKeepAlive: 657873
IpExt:
    InOctets: 1700387324043
    OutOctets: 3388960888071
    InNoECTPkts: 4665943883
root@ip-172-1-52-100:~#
```

更好的方式：

- `watch -d -c -n 1 netstat -st`
- 直接将统计信息做到监控中，然后读图

![172-1-52-100_netstat](https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/172-1-52-100_netstat.png)


主要变化内容：

```
    7203944 times the listen queue of a socket overflowed
    7203944 SYNs to LISTEN sockets dropped
    4075063 packet headers predicted
    2329225 acknowledgments not containing data payload received
    699350 predicted acknowledgments
...
    2702643 other TCP timeouts
...
    TCPSynRetrans: 2254301
    TCPOrigDataSent: 4484059
```


> 详细解释移步《[TCP 统计信息详解](https://github.com/moooofly/MarkSomethingDown/blob/master/Linux/TCP%20%E7%9B%B8%E5%85%B3%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF%E8%AF%A6%E8%A7%A3.md)》


## 对比示例

- 侧面确认 accept queue 中的积压都是由于 CLOSE-WAIT 导致；

```
root@ip-172-1-52-100:~# ss -napt|grep 30613
LISTEN     68     128                      :::30613                   :::*      users:(("kube-proxy",pid=1515,fd=33))
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:8647
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:62690
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:63136
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:10739
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:50739
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:38375
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:51193
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:19193
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:45691
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:59243
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:29149
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:30808
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:19451
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:31260
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:47277
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:62086
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:51339
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:50891
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:62386
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:2002
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:31304
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:51793
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:63442
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:23606
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:37993
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:51495
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:34983
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:59397
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:13365
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:25832
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:51641
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:62990
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:26251
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:12183
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:31114
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:45843
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:27153
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:62534
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:51945
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:62232
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:45545
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:63290
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:55499
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:33490
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:31410
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:12333
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:23756
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:30815
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:38527
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:52095
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:38683
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:32079
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:38398
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:31604
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:62838
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:40024
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:21367
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:45997
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:45387
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:19914
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:20148
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:39868
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613  ::ffff:172.1.46.175:41254
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:23902
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:58201
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:14666
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:30964
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:30613   ::ffff:172.1.41.13:51043
```


- 分析后发现，端口 31591 是最有意思的一个，因为只有其上存在大量数据积压

```
root@ip-172-1-52-100:~# ss -antp| grep "31591"
State      Recv-Q Send-Q        Local Address:Port          Peer Address:Port
LISTEN     72     128                      :::31591                   :::*      users:(("kube-proxy",pid=1515,fd=18))
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:23094
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:3484
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:55642
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:16637
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:42751
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:17129
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:60482
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:1441
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:20333
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:58098
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:1310
CLOSE-WAIT 2367   0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:58102
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:57636
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:33457
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:33373
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:16547
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:45665
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:19894
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:56087
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:3322
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:15626
CLOSE-WAIT 2698   0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:1141
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:58100
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:1335
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:16785
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:63903
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:46792
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:4364
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:61449
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:32072
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:57788
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:19653
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:47973
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:39722
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:28150
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:57777
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:58088
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:34443
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:5834
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:19757
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:2227
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:2861
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:41200
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:45341
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:60624
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:9004
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:43666
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:10529
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:18726
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:45509
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:16961
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:57624
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:42151
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:57634
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:1333
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:17083
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:42791
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:58080
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:10613
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:20275
CLOSE-WAIT 3641   0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:44255
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:18648
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:62570
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:41716
CLOSE-WAIT 2039   0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:26363
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:7726
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:30948
CLOSE-WAIT 10507  0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:57410
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:41110
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:41530
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.55.148:43469
CLOSE-WAIT 1      0       ::ffff:172.1.52.100:31591  ::ffff:172.1.41.128:3150
root@ip-172-1-52-100:~#
```



------



其他参数

```
root@ip-172-1-52-100:~# sysctl -a|grep nf_conntrack_tcp
net.netfilter.nf_conntrack_tcp_be_liberal = 0
net.netfilter.nf_conntrack_tcp_loose = 1
net.netfilter.nf_conntrack_tcp_max_retrans = 3
net.netfilter.nf_conntrack_tcp_timeout_close = 10
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 3600
net.netfilter.nf_conntrack_tcp_timeout_established = 86400
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120
net.netfilter.nf_conntrack_tcp_timeout_last_ack = 30
net.netfilter.nf_conntrack_tcp_timeout_max_retrans = 300
net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 60
net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 120
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120
net.netfilter.nf_conntrack_tcp_timeout_unacknowledged = 300
root@ip-172-1-52-100:~#
```

